<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üî¨Laberinto de F√≠sica ‚öõÔ∏è v3</title>
    <style>
        /* ===========================================
           VARIABLES CSS - MANTENIENDO LO QUE FUNCIONABA
           =========================================== */
        :root {
            --background: 240 10% 3.9%;
            --foreground: 0 0% 98%;
            --card: 240 10% 3.9%;
            --card-foreground: 0 0% 98%;
            --primary: 250 47% 60%; /* Violeta primario */
            --primary-foreground: 0 0% 98%;
            --secondary: 240 3.7% 15.9%; /* Gris oscuro secundario */
            --secondary-foreground: 0 0% 98%;
            --muted: 240 3.7% 15.9%;
            --muted-foreground: 240 5% 64.9%; /* Gris claro texto */
            --accent: 48 96% 68%; /* Amarillo acento */
            --accent-foreground: 240 5.9% 10%;
            --destructive: 0 62.8% 30.6%; /* Rojo destructivo */
            --destructive-foreground: 0 0% 98%;
            --wall-color: 250 47% 40%; /* Color pared */
            --player-color: 48 96% 68%; /* Color jugador (amarillo) */
            --ghost-color: 199 89% 64%; /* Color fantasma base */
            --power-pellet-color: 30 100% 50%; /* Naranja para power pellet */
            --help-button-color: 210 80% 60%; /* Azul claro para ayuda */
            --help-button-hover: 210 80% 50%;
            --question-title-color: var(--accent); /* Amarillo para t√≠tulo pregunta */
            --option-hover-bg: hsl(var(--muted) / 0.8);
            --option-selected-bg: hsl(var(--primary) / 0.7);
            --option-selected-border: hsl(var(--accent));
        }

        /* ===========================================
           RESET Y ESTILOS BASE
           =========================================== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            padding-bottom: 60px; /* Espacio para footer */
        }

        /* ===========================================
           BOTONES GLOBALES - MEJORANDO LOS ORIGINALES
           =========================================== */
        #globalControlButtons {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            display: flex;
            gap: 8px;
        }
        
        .global-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s ease;
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            border: 1px solid hsl(var(--muted-foreground));
        }
        
        .global-btn:hover { background-color: hsl(var(--muted)); }
        .global-btn:active { transform: scale(0.95); }

        /* ===========================================
           ESTILOS GENERALES DE BOTONES - MEJORADOS
           =========================================== */
        .button {
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 0.5rem; 
            font-weight: 500; 
            padding: 0.6rem 1.2rem; /* M√°s padding */
            transition: background-color 0.2s, transform 0.1s ease; 
            cursor: pointer; 
            border: none;
        }
        
        .button-primary { 
            background-color: hsl(var(--primary)); 
            color: hsl(var(--primary-foreground)); 
        }
        .button-primary:hover { 
            background-color: hsl(var(--primary) / 0.9); 
        }
        
        .button-secondary { 
            background-color: hsl(var(--secondary)); 
            color: hsl(var(--secondary-foreground)); 
            border: 1px solid hsl(var(--muted-foreground));
        }
        .button-secondary:hover { 
            background-color: hsl(var(--muted)); 
        }
        
        .button-accent { 
            background-color: hsl(var(--accent)); 
            color: hsl(var(--accent-foreground)); 
        }
        .button-accent:hover { 
            background-color: hsl(var(--accent) / 0.9); 
        }
        
        .button-help { 
            background-color: var(--help-button-color); 
            color: hsl(var(--primary-foreground)); 
        }
        .button-help:hover { 
            background-color: var(--help-button-hover); 
        }
        
        .button:active { transform: scale(0.97); }

        /* ===========================================
           LAYOUT PRINCIPAL
           =========================================== */
        .container { max-width: 1000px; width: 100%; padding: 1rem; }
        
        .card {
            background-color: hsl(var(--card)); 
            color: hsl(var(--card-foreground));
            border-radius: 0.75rem; 
            padding: 2rem; 
            box-shadow: 0 6px 12px rgba(0,0,0,0.2); 
            text-align: center;
        }
        
        .header { text-align: center; margin-bottom: 1.5rem; }
        .header h1 { 
            font-size: 2.2rem; 
            color: hsl(var(--primary)); 
            margin-bottom: 0.5rem; 
        }

        /* ===========================================
           SELECTOR DE NIVEL - MANTENIENDO FUNCIONAMIENTO
           =========================================== */
        .level-selector { text-align: center; max-width: 500px; margin: 0 auto; }
        .level-selector h2 { margin-bottom: 1rem; font-size: 1.5rem; }
        .level-selector p { 
            margin-bottom: 1.5rem; 
            color: hsl(var(--muted-foreground));
        }
        
        .level-tabs { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 0.75rem; 
            margin: 1rem 0; 
        }
        
        .level-tab {
            background-color: hsl(var(--secondary)); 
            color: hsl(var(--secondary-foreground)); 
            border: none;
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            transition: background-color 0.2s, transform 0.1s ease;
            font-weight: 500;
        }
        .level-tab:hover { background-color: hsl(var(--muted)); }
        .level-tab.active { 
            background-color: hsl(var(--primary)); 
            color: hsl(var(--primary-foreground)); 
        }
        .level-tab:active { transform: scale(0.95); }
        
        .level-description { 
            font-size: 0.9rem; 
            margin-top: 1rem; 
            color: hsl(var(--muted-foreground)); 
            min-height: 40px; 
        }
        
        #buttonContainer { 
            display: flex; 
            flex-direction: column; 
            gap: 1rem; 
            margin-top: 1.5rem; 
        }

        /* ===========================================
           UI DEL JUEGO - PRESERVANDO FUNCIONAMIENTO
           =========================================== */
        .game-ui-bar {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            max-width: 600px; 
            margin: 0 auto 1rem auto;
            gap: 1rem; 
            flex-wrap: wrap;
        }
        
        .game-stats { display: flex; gap: 1rem; flex-wrap: wrap; }
        
        .stat-item {
            display: flex; 
            align-items: center; 
            gap: 0.5rem;
            background-color: hsl(var(--secondary) / 0.8); 
            padding: 0.4rem 0.8rem;
            border-radius: 1rem; 
            font-size: 0.9rem; 
            font-weight: 500;
        }
        
        .stat-item span:first-child { font-size: 1.2rem; }
        #livesValue { color: hsl(var(--destructive)); font-weight: bold; }
        #scoreValue { color: hsl(var(--accent)); font-weight: bold; }
        #questionProgressValue { color: hsl(var(--primary)); font-weight: bold; }

        /* ===========================================
           BARRA DE PROGRESO
           =========================================== */
        .progress-display { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            max-width: 600px; 
            margin: 0 auto 1rem auto; 
        }
        .progress-display span:first-child { 
            font-size: 0.9rem; 
            font-weight: 500;
        }
        .progress-container { 
            flex-grow: 1; 
            height: 10px; 
            background-color: hsl(var(--secondary)); 
            border-radius: 5px; 
            overflow: hidden; 
        }
        .progress-bar { 
            height: 100%; 
            background-color: hsl(var(--primary)); 
            transition: width 0.3s; 
            border-radius: 5px; 
        }

        /* ===========================================
           LABERINTO - MANTENIENDO ESTILOS FUNCIONALES
           =========================================== */
        .game-maze {
            background-color: hsl(var(--background)); 
            position: relative; 
            margin: 0 auto;
            overflow: hidden; 
            border: 4px solid hsl(var(--wall-color));
            box-shadow: 0 0 20px rgba(139,92,246,0.5); 
            border-radius: 0.5rem;
        }
        
        #staticContainer, #dynamicContainer { 
            position: absolute; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
        }
        
        .wall { 
            background-color: hsl(var(--wall-color)); 
            position: absolute; 
        }
        
        .fruit, .power-pellet {
            position: absolute; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            animation: pulse 2s infinite ease-in-out;
        }
        
        .fruit { font-size: var(--fruit-size, 16px); }
        .power-pellet {
            font-size: var(--power-pellet-size, 20px);
            animation-duration: 1s;
            text-shadow: 0 0 8px var(--power-pellet-color);
        }
        
        @keyframes pulse { 
            0%, 100% { transform: scale(1); } 
            50% { transform: scale(1.15); } 
        }

        /* ===========================================
           JUGADOR (PAC-MAN) - MANTENIENDO FUNCIONAMIENTO
           =========================================== */
        .pacman-player {
            width: var(--player-size, 20px); 
            height: var(--player-size, 20px);
            background-color: hsl(var(--player-color)); 
            border-radius: 50%; 
            position: absolute;
            transition: left 0.1s linear, top 0.1s linear, transform 0.1s linear;
        }
        
        .pacman-mouth {
            width: 50%; 
            height: 100%; 
            background-color: hsl(var(--background));
            position: absolute; 
            top: 0; 
            right: 0;
            clip-path: polygon(100% 0%, 40% 50%, 100% 100%);
            animation: chomp 0.3s linear infinite;
            transform-origin: left center;
        }
        
        .pacman-player[data-direction="right"] .pacman-mouth { transform: rotate(0deg); }
        .pacman-player[data-direction="left"] .pacman-mouth { transform: rotate(180deg); }
        .pacman-player[data-direction="up"] .pacman-mouth { transform: rotate(-90deg); }
        .pacman-player[data-direction="down"] .pacman-mouth { transform: rotate(90deg); }

        @keyframes chomp {
            0%, 100% { clip-path: polygon(100% 0%, 40% 50%, 100% 100%); }
            50% { clip-path: polygon(100% 40%, 40% 50%, 100% 60%); }
        }

        /* ===========================================
           FANTASMAS - MANTENIENDO FUNCIONAMIENTO
           =========================================== */
        .ghost {
            width: var(--ghost-size, 20px); 
            height: var(--ghost-size, 20px);
            border-radius: 50% 50% 35% 35%; 
            position: absolute;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); 
            transition: left 0.3s ease, top 0.3s ease;
            display: flex; 
            justify-content: center; 
            align-items: flex-start;
            padding-top: 4px;
        }
        
        .ghost-eyes { position: relative; display: flex; gap: 4px; }
        .ghost-eye {
            width: 5px; 
            height: 7px; 
            background-color: white; 
            border-radius: 50%;
            position: relative; 
            border: 1px solid black;
        }
        .ghost-pupil {
            width: 2px; 
            height: 3px; 
            background-color: black; 
            border-radius: 50%;
            position: absolute; 
            top: 2px; 
            left: 1.5px;
            transition: transform 0.1s linear;
        }
        
        .ghost[data-look="right"] .ghost-pupil { transform: translateX(0.5px); }
        .ghost[data-look="left"] .ghost-pupil { transform: translateX(-0.5px); }
        .ghost[data-look="down"] .ghost-pupil { transform: translateY(1px); }
        .ghost[data-look="up"] .ghost-pupil { transform: translateY(-1px); }

        /* ===========================================
           CONTROLES M√ìVILES
           =========================================== */
        .mobile-controls {
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr);
            gap: 8px; 
            width: 160px; 
            height: 160px; 
            margin: 20px auto 0;
        }
        
        .mobile-controls button {
            background-color: hsl(var(--primary)); 
            color: hsl(var(--primary-foreground)); 
            border-radius: 8px;
            border: none; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: transform 0.2s; 
            cursor: pointer; 
            font-size: 1.5rem;
        }
        .mobile-controls button:active { 
            transform: scale(0.95); 
            background-color: hsl(var(--primary) / 0.8); 
        }
        
        .up { grid-column: 2; grid-row: 1; } 
        .left { grid-column: 1; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; } 
        .down { grid-column: 2; grid-row: 3; }

        /* ===========================================
           DI√ÅLOGOS - ESTRUCTURA B√ÅSICA
           =========================================== */
        .dialog-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: rgba(0,0,0,0.7);
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            backdrop-filter: blur(4px);
        }
        
        .dialog-content {
            background-color: hsl(var(--card)); 
            border-radius: 0.75rem; 
            padding: 1.5rem 2rem;
            width: 90%; 
            max-width: 500px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            color: hsl(var(--card-foreground));
        }
        
        .dialog-header { margin-bottom: 1rem; text-align: center; }
        .dialog-title { 
            font-size: 1.6rem; 
            font-weight: bold; 
            margin-bottom: 0.75rem; 
            color: hsl(var(--primary)); 
        }
        .dialog-description { 
            color: hsl(var(--muted-foreground)); 
            font-size: 0.95rem; 
        }
        .dialog-body { margin-top: 1.5rem; }
        .dialog-footer { 
            display: flex; 
            justify-content: center; 
            margin-top: 1.5rem; 
        }

        /* ===========================================
           NOTIFICACIONES TOAST
           =========================================== */
        .toast-container { 
            position: fixed; 
            bottom: 1rem; 
            right: 1rem; 
            z-index: 1000; 
        }
        .toast {
            background-color: hsl(var(--card)); 
            color: hsl(var(--foreground)); 
            border-radius: 0.5rem;
            padding: 1rem; 
            margin-top: 0.5rem; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: opacity 0.3s, transform 0.3s; 
            max-width: 350px; 
            border-left: 4px solid;
        }
        .toast-title { font-weight: bold; margin-bottom: 0.25rem; }
        .toast-default { border-left-color: hsl(var(--primary)); }
        .toast-default .toast-title { color: hsl(var(--primary)); }
        .toast-destructive { border-left-color: hsl(var(--destructive)); }
        .toast-destructive .toast-title { color: hsl(var(--destructive)); }
        .toast-success { border-left-color: #2ecc71; }
        .toast-success .toast-title { color: #2ecc71; }

        /* ===========================================
           FOOTER
           =========================================== */
        footer {
            text-align: center; 
            padding: 1rem 0; 
            color: hsl(var(--muted-foreground));
            margin-top: 2rem; 
            font-size: 0.85rem;
        }

        /* ===========================================
           MEDIA QUERIES
           =========================================== */
        @media (max-width: 768px) {
            body { padding: 0.5rem; padding-bottom: 50px; }
            .container { padding: 0.5rem; }
            .header h1 { font-size: 1.8rem; }
            .card { padding: 1.5rem; }
            .game-maze { 
                border-width: 2px; 
                box-shadow: 0 0 10px rgba(139,92,246,0.3); 
            }
            .game-ui-bar { justify-content: center; }
            .mobile-controls { width: 180px; height: 180px; gap: 10px; }
            .dialog-content { width: 95%; padding: 1.5rem; }
            .dialog-title { font-size: 1.3rem; }
            #globalControlButtons { 
                flex-direction: column; 
                right: 5px; 
                top: 5px; 
                gap: 5px; 
            }
            .global-btn { padding: 0.4rem 0.8rem; font-size: 0.8rem;}
        }
    </style>
</head>
<body>
    <!-- Botones de control global -->
    <div id="globalControlButtons">
        <button id="globalPauseBtn" class="global-btn">Pausar</button>
        <button id="globalResetBtn" class="global-btn">Reiniciar</button>
    </div>

    <!-- Contenedor principal -->
    <div class="container">
        <header class="header">
            <h1>üî¨Laberinto de F√≠sica ‚öõÔ∏è v3</h1>
        </header>

        <!-- Aqu√≠ se renderizar√° el contenido din√°micamente -->
        <div id="app">
            <!-- Contenido temporal mientras se carga el JavaScript -->
            <div class="level-selector card">
                <h2>Cargando...</h2>
                <p>El juego se est√° inicializando. Si este mensaje persiste, revisa la consola del navegador.</p>
            </div>
        </div>

        <!-- Contenedor para notificaciones -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Di√°logos (se completar√°n en las siguientes partes) -->
        <div id="questionDialog" class="dialog-overlay" style="display: none;">
            <div class="dialog-content">
                <div class="dialog-header">
                    <h2 class="dialog-title">¬°Pregunta de F√≠sica!</h2>
                    <p class="dialog-description">Selecciona la respuesta correcta</p>
                </div>
                <div class="dialog-body">
                    <div id="questionText"></div>
                    <div id="optionsContainer"></div>
                </div>
            </div>
        </div>

        <div id="completionDialog" class="dialog-overlay" style="display: none;">
            <div class="dialog-content">
                <div class="dialog-header">
                    <h2 id="completionTitle" class="dialog-title"></h2>
                    <p id="completionDescription" class="dialog-description"></p>
                </div>
                <div id="completionStats" class="dialog-body"></div>
                <div class="dialog-footer">
                    <button id="playAgainBtn" class="button button-primary">Jugar de nuevo</button>
                </div>
            </div>
        </div>

        <div id="helpDialog" class="dialog-overlay" style="display: none;">
            <div class="dialog-content">
                <div class="dialog-header">
                    <h2 class="dialog-title">Ayuda del Juego</h2>
                </div>
                <div class="dialog-body">
                    <h3>Contenido de ayuda se a√±adir√° en las siguientes partes...</h3>
                </div>
                <div class="dialog-footer">
                    <button id="closeHelpBtn" class="button button-secondary">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        Autor: Msc N√©stor Fabio Montoya Palacios
    </footer>

    <!-- El JavaScript se a√±adir√° en las siguientes partes -->
    <script>
        // ===============================================================
// üî¨ LABERINTO DE F√çSICA v3 - PARTE 2
// BANCO DE PREGUNTAS MEJORADO + CONSTANTES DEL JUEGO
// ===============================================================

console.log("üî¨ Laberinto de F√≠sica v3 - Parte 2 iniciando...");

// ===============================================================
// üìä CONSTANTES DEL JUEGO
// ===============================================================
const GAME_CONFIG = {
    // Tama√±os base del juego (se ajustar√°n din√°micamente)
    CELL_SIZE: 30,
    PLAYER_SIZE: 20,
    GHOST_SIZE: 20,
    FRUIT_SIZE: 16,
    POWER_PELLET_SIZE: 20,
    
    // Configuraci√≥n de gameplay
    GHOST_MOVE_INTERVAL: 1000, // Velocidad base de fantasmas (ms)
    MAX_LIVES: 8, // Reducido para mayor desaf√≠o
    POWER_PELLET_COUNT: 2,
    VULNERABLE_TIME: 8000, // Tiempo que fantasmas son vulnerables (ms)
    
    // Puntuaci√≥n por nivel
    POINTS: {
        FRUIT_BASIC: 5,
        QUESTION_EASY: 10,
        QUESTION_MEDIUM: 20,
        QUESTION_HARD: 30,
        QUESTION_EXPERT: 40,
        GHOST_EATEN: 50, // Nuevo: puntos por comer fantasma
        SPEED_BONUS: 5   // Bonus por respuesta r√°pida
    },
    
    // Configuraci√≥n de niveles
    LEVELS: {
        easy: {
            name: "F√°cil",
            description: "Magnitudes fundamentales y Sistema Internacional",
            questionCount: 12,
            ghostCount: 1,
            ghostSpeed: 1200
        },
        medium: {
            name: "Medio", 
            description: "Cinem√°tica b√°sica y Movimiento Rectil√≠neo Uniforme",
            questionCount: 16,
            ghostCount: 2,
            ghostSpeed: 1000
        },
        hard: {
            name: "Dif√≠cil",
            description: "MRUA, Movimiento Vertical y Ca√≠da Libre",
            questionCount: 20,
            ghostCount: 3,
            ghostSpeed: 800
        },
        expert: {
            name: "Experto",
            description: "Movimiento Circular y Parab√≥lico Completo",
            questionCount: 25,
            ghostCount: 4,
            ghostSpeed: 600
        }
    }
};

// ===============================================================
// üìö BANCO DE PREGUNTAS MEJORADO POR TEMAS
// Total: 105+ preguntas organizadas por temas espec√≠ficos
// ===============================================================

const QUESTION_BANK = {
    // ============================================
    // üìè TEMA 1: MAGNITUDES FUNDAMENTALES (15 preguntas)
    // ============================================
    magnitudes: [
        {
            tema: "Magnitudes",
            question: "¬øCu√°l es la unidad fundamental del SI para la masa?",
            opciones: ["Gramo (g)", "Libra (lb)", "Kilogramo (kg)", "Onza (oz)"],
            respuestaCorrecta: "Kilogramo (kg)",
            explicacion: "El kilogramo es una de las 7 unidades fundamentales del Sistema Internacional."
        },
        {
            tema: "Magnitudes",
            question: "¬øCu√°l de estas es una magnitud escalar?",
            opciones: ["Velocidad", "Fuerza", "Temperatura", "Aceleraci√≥n"],
            respuestaCorrecta: "Temperatura",
            explicacion: "Las magnitudes escalares solo tienen valor num√©rico, sin direcci√≥n."
        },
        {
            tema: "Magnitudes",
            question: "¬øCu√°l de estas es una magnitud vectorial?",
            opciones: ["Masa", "Tiempo", "Desplazamiento", "Energ√≠a"],
            respuestaCorrecta: "Desplazamiento",
            explicacion: "Las magnitudes vectoriales tienen magnitud, direcci√≥n y sentido."
        },
        {
            tema: "Magnitudes",
            question: "¬øQu√© prefijo del SI representa 10^6?",
            opciones: ["Kilo", "Mega", "Giga", "Mili"],
            respuestaCorrecta: "Mega",
            explicacion: "Mega (M) equivale a un mill√≥n de veces la unidad base."
        },
        {
            tema: "Magnitudes",
            question: "¬øQu√© prefijo del SI representa 10^-3?",
            opciones: ["Micro", "Nano", "Mili", "Centi"],
            respuestaCorrecta: "Mili",
            explicacion: "Mili (m) equivale a una mil√©sima parte de la unidad base."
        },
        {
            tema: "Magnitudes",
            question: "¬øCu√°l es la unidad SI para la intensidad de corriente el√©ctrica?",
            opciones: ["Volt (V)", "Ohm (Œ©)", "Ampere (A)", "Watt (W)"],
            respuestaCorrecta: "Ampere (A)",
            explicacion: "El ampere es una de las 7 unidades fundamentales del SI."
        },
        {
            tema: "Magnitudes",
            question: "¬øCu√°l es la unidad SI para la cantidad de sustancia?",
            opciones: ["Mol (mol)", "Gramo (g)", "Litro (L)", "Metro c√∫bico (m¬≥)"],
            respuestaCorrecta: "Mol (mol)",
            explicacion: "El mol es la unidad fundamental para medir cantidad de sustancia."
        },
        {
            tema: "Magnitudes",
            question: "¬øCu√°ntos metros tiene 1 kil√≥metro?",
            opciones: ["100 m", "1000 m", "10000 m", "100000 m"],
            respuestaCorrecta: "1000 m",
            explicacion: "Kilo significa mil, por lo tanto 1 km = 1000 m."
        },
        {
            tema: "Magnitudes",
            question: "¬øCu√°l es la unidad SI para la temperatura termodin√°mica?",
            opciones: ["Celsius (¬∞C)", "Kelvin (K)", "Fahrenheit (¬∞F)", "Rankine (¬∞R)"],
            respuestaCorrecta: "Kelvin (K)",
            explicacion: "El kelvin es la unidad fundamental de temperatura en el SI."
        },
        {
            tema: "Magnitudes",
            question: "¬øQu√© representa el prefijo 'nano' en el SI?",
            opciones: ["10^-6", "10^-9", "10^-12", "10^-3"],
            respuestaCorrecta: "10^-9",
            explicacion: "Nano (n) representa una mil millon√©sima parte (10^-9)."
        },
        {
            tema: "Magnitudes",
            question: "¬øCu√°l de estas NO es una unidad fundamental del SI?",
            opciones: ["Metro", "Segundo", "Newton", "Kelvin"],
            respuestaCorrecta: "Newton",
            explicacion: "Newton es una unidad derivada (kg‚ãÖm‚ãÖs^-2), no fundamental."
        },
        {
            tema: "Magnitudes",
            question: "¬øQu√© magnitud mide la cantidad de materia en un objeto?",
            opciones: ["Peso", "Masa", "Volumen", "Densidad"],
            respuestaCorrecta: "Masa",
            explicacion: "La masa es invariante y mide la cantidad de materia."
        },
        {
            tema: "Magnitudes",
            question: "¬øCu√°l es la diferencia entre rapidez y velocidad?",
            opciones: [
                "No hay diferencia",
                "Rapidez es escalar, velocidad es vectorial", 
                "Rapidez es mayor que velocidad",
                "Velocidad es solo para movimiento recto"
            ],
            respuestaCorrecta: "Rapidez es escalar, velocidad es vectorial",
            explicacion: "Rapidez solo tiene magnitud, velocidad tiene magnitud y direcci√≥n."
        },
        {
            tema: "Magnitudes",
            question: "¬øCu√°ntos gramos hay en 2.5 kilogramos?",
            opciones: ["250 g", "2500 g", "25 g", "25000 g"],
            respuestaCorrecta: "2500 g",
            explicacion: "1 kg = 1000 g, entonces 2.5 kg = 2500 g."
        },
        {
            tema: "Magnitudes",
            question: "¬øQu√© prefijo representa 10^12?",
            opciones: ["Giga", "Tera", "Peta", "Mega"],
            respuestaCorrecta: "Tera",
            explicacion: "Tera (T) representa un bill√≥n de veces la unidad base."
        }
    ],

    // ============================================
    // üéØ TEMA 2: CINEM√ÅTICA B√ÅSICA (15 preguntas)
    // ============================================
    cinematica: [
        {
            tema: "Cinem√°tica",
            question: "¬øQu√© es un sistema de referencia?",
            opciones: [
                "Un punto fijo en el espacio",
                "Un conjunto de coordenadas para describir posici√≥n",
                "La velocidad de un objeto",
                "El origen de coordenadas √∫nicamente"
            ],
            respuestaCorrecta: "Un conjunto de coordenadas para describir posici√≥n",
            explicacion: "Un sistema de referencia permite ubicar objetos en el espacio y tiempo."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øQu√© representa el vector de posici√≥n?",
            opciones: [
                "La distancia recorrida",
                "La ubicaci√≥n de una part√≠cula respecto al origen",
                "La velocidad instant√°nea",
                "El tiempo transcurrido"
            ],
            respuestaCorrecta: "La ubicaci√≥n de una part√≠cula respecto al origen",
            explicacion: "El vector posici√≥n va del origen hasta la ubicaci√≥n de la part√≠cula."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øCu√°l es la diferencia entre distancia y desplazamiento?",
            opciones: [
                "No hay diferencia",
                "Distancia es escalar, desplazamiento es vectorial",
                "Desplazamiento es siempre mayor",
                "Distancia puede ser negativa"
            ],
            respuestaCorrecta: "Distancia es escalar, desplazamiento es vectorial",
            explicacion: "Distancia es la longitud total recorrida, desplazamiento es el cambio de posici√≥n."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øCu√°ndo se dice que una part√≠cula est√° en reposo?",
            opciones: [
                "Cuando no se mueve respecto a ning√∫n sistema",
                "Cuando su posici√≥n no cambia respecto al sistema de referencia",
                "Cuando su velocidad es muy peque√±a",
                "Cuando est√° en el origen de coordenadas"
            ],
            respuestaCorrecta: "Cuando su posici√≥n no cambia respecto al sistema de referencia",
            explicacion: "El reposo es relativo al sistema de referencia elegido."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øQu√© es la trayectoria de una part√≠cula?",
            opciones: [
                "Su velocidad final",
                "El conjunto de posiciones que ocupa durante su movimiento",
                "Su aceleraci√≥n promedio",
                "La distancia total recorrida"
            ],
            respuestaCorrecta: "El conjunto de posiciones que ocupa durante su movimiento",
            explicacion: "La trayectoria es la l√≠nea que describe el movimiento de la part√≠cula."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øQu√© mide la velocidad instant√°nea?",
            opciones: [
                "El desplazamiento total",
                "La rapidez promedio",
                "La rapidez y direcci√≥n en un instante espec√≠fico",
                "La aceleraci√≥n en ese momento"
            ],
            respuestaCorrecta: "La rapidez y direcci√≥n en un instante espec√≠fico",
            explicacion: "La velocidad instant√°nea es la derivada de la posici√≥n respecto al tiempo."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øCu√°l es la unidad SI de la velocidad?",
            opciones: ["m/s", "km/h", "cm/s", "m/s¬≤"],
            respuestaCorrecta: "m/s",
            explicacion: "Metro por segundo es la unidad est√°ndar de velocidad en el SI."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øQu√© representa la aceleraci√≥n?",
            opciones: [
                "El cambio de posici√≥n",
                "El cambio de velocidad por unidad de tiempo",
                "La velocidad m√°xima",
                "La distancia recorrida"
            ],
            respuestaCorrecta: "El cambio de velocidad por unidad de tiempo",
            explicacion: "La aceleraci√≥n mide c√≥mo cambia la velocidad con el tiempo."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øCu√°l es la unidad SI de la aceleraci√≥n?",
            opciones: ["m/s", "m/s¬≤", "N", "kg‚ãÖm/s"],
            respuestaCorrecta: "m/s¬≤",
            explicacion: "Metro por segundo al cuadrado es la unidad de aceleraci√≥n."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øQu√© significa que el movimiento es relativo?",
            opciones: [
                "Que depende del observador",
                "Que es muy lento",
                "Que cambia con el tiempo",
                "Que es aproximado"
            ],
            respuestaCorrecta: "Que depende del observador",
            explicacion: "El movimiento siempre se describe respecto a un sistema de referencia."
        },
        {
            tema: "Cinem√°tica",
            question: "Si un objeto regresa a su posici√≥n inicial, ¬øcu√°l es su desplazamiento?",
            opciones: ["Igual a la distancia recorrida", "Cero", "Depende del tiempo", "Infinito"],
            respuestaCorrecta: "Cero",
            explicacion: "El desplazamiento es el cambio neto de posici√≥n, no la distancia recorrida."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øCu√°ndo la rapidez promedio es igual a la velocidad promedio?",
            opciones: [
                "Siempre",
                "Nunca", 
                "Cuando el movimiento es en l√≠nea recta y sin cambio de direcci√≥n",
                "Solo en ca√≠da libre"
            ],
            respuestaCorrecta: "Cuando el movimiento es en l√≠nea recta y sin cambio de direcci√≥n",
            explicacion: "En movimiento rectil√≠neo sin cambio de sentido, ambas coinciden."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øQu√© estudia la cinem√°tica?",
            opciones: [
                "Las causas del movimiento",
                "La descripci√≥n del movimiento sin considerar sus causas",
                "Solo el movimiento circular",
                "Las fuerzas aplicadas"
            ],
            respuestaCorrecta: "La descripci√≥n del movimiento sin considerar sus causas",
            explicacion: "La cinem√°tica describe c√≥mo se mueven los objetos, no por qu√©."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øPuede un objeto tener velocidad cero y aceleraci√≥n no cero?",
            opciones: ["No, es imposible", "S√≠, en el punto m√°s alto de un lanzamiento vertical", "Solo en movimiento circular", "Solo en ca√≠da libre"],
            respuestaCorrecta: "S√≠, en el punto m√°s alto de un lanzamiento vertical",
            explicacion: "En el punto m√°s alto, v=0 pero a=-g (aceleraci√≥n gravitatoria)."
        },
        {
            tema: "Cinem√°tica",
            question: "¬øQu√© es una part√≠cula en f√≠sica?",
            opciones: [
                "Un √°tomo",
                "Un objeto cuyas dimensiones son despreciables",
                "Una mol√©cula peque√±a",
                "Solo objetos microsc√≥picos"
            ],
            respuestaCorrecta: "Un objeto cuyas dimensiones son despreciables",
            explicacion: "Una part√≠cula es un modelo donde se ignoran las dimensiones del objeto."
        }
    ],

    // ============================================
    // üèÉ‚Äç‚ôÇÔ∏è TEMA 3: MOVIMIENTO RECTIL√çNEO UNIFORME - MRU (15 preguntas)
    // ============================================
    mru: [
        {
            tema: "MRU",
            question: "En un MRU, ¬øc√≥mo es la velocidad?",
            opciones: ["Variable", "Constante", "Creciente", "Decreciente"],
            respuestaCorrecta: "Constante",
            explicacion: "En el MRU, la velocidad permanece constante en magnitud y direcci√≥n."
        },
        {
            tema: "MRU",
            question: "¬øCu√°l es la ecuaci√≥n correcta para la posici√≥n en MRU?",
            opciones: ["x = v¬≤t", "x = x‚ÇÄ + vt", "x = ¬Ωat¬≤", "x = vt¬≤"],
            respuestaCorrecta: "x = x‚ÇÄ + vt",
            explicacion: "En MRU, la posici√≥n es la posici√≥n inicial m√°s velocidad por tiempo."
        },
        {
            tema: "MRU",
            question: "En un MRU, ¬øcu√°l es la aceleraci√≥n?",
            opciones: ["Constante y diferente de cero", "Variable", "Cero", "Negativa"],
            respuestaCorrecta: "Cero",
            explicacion: "En MRU no hay cambio de velocidad, por lo tanto a = 0."
        },
        {
            tema: "MRU",
            question: "Si v = Œîx/Œît, ¬øqu√© representa esta ecuaci√≥n?",
            opciones: ["Aceleraci√≥n", "Velocidad promedio", "Fuerza", "Energ√≠a"],
            respuestaCorrecta: "Velocidad promedio",
            explicacion: "Es la definici√≥n de velocidad promedio: cambio de posici√≥n sobre tiempo."
        },
        {
            tema: "MRU",
            question: "Un auto viaja 120 km en 2 horas con MRU. ¬øCu√°l es su velocidad?",
            opciones: ["60 km/h", "240 km/h", "30 km/h", "90 km/h"],
            respuestaCorrecta: "60 km/h",
            explicacion: "v = Œîx/Œît = 120 km / 2 h = 60 km/h"
        },
        {
            tema: "MRU",
            question: "¬øCu√°l es la velocidad del sonido en el aire aproximadamente?",
            opciones: ["300 m/s", "340 m/s", "400 m/s", "280 m/s"],
            respuestaCorrecta: "340 m/s",
            explicacion: "La velocidad del sonido en aire a 20¬∞C es aproximadamente 340 m/s."
        },
        {
            tema: "MRU",
            question: "¬øCu√°l es la velocidad de la luz en el vac√≠o?",
            opciones: ["3√ó10‚Å∏ m/s", "3√ó10‚Å∂ m/s", "3√ó10¬π‚Å∞ m/s", "3√ó10‚Åµ m/s"],
            respuestaCorrecta: "3√ó10‚Å∏ m/s",
            explicacion: "La velocidad de la luz en el vac√≠o es 299,792,458 m/s ‚âà 3√ó10‚Å∏ m/s."
        },
        {
            tema: "MRU",
            question: "En MRU, si duplicamos el tiempo, ¬øqu√© pasa con la distancia recorrida?",
            opciones: ["Se mantiene igual", "Se duplica", "Se cuadruplica", "Se reduce a la mitad"],
            respuestaCorrecta: "Se duplica",
            explicacion: "En MRU, x ‚àù t, por lo tanto si t se duplica, x tambi√©n se duplica."
        },
        {
            tema: "MRU",
            question: "¬øC√≥mo es la gr√°fica velocidad vs. tiempo en un MRU?",
            opciones: ["Una l√≠nea recta horizontal", "Una l√≠nea inclinada", "Una par√°bola", "Una curva"],
            respuestaCorrecta: "Una l√≠nea recta horizontal",
            explicacion: "En MRU la velocidad es constante, generando una l√≠nea horizontal."
        },
        {
            tema: "MRU",
            question: "¬øC√≥mo es la gr√°fica posici√≥n vs. tiempo en un MRU?",
            opciones: ["Una l√≠nea horizontal", "Una l√≠nea recta inclinada", "Una par√°bola", "Una curva exponencial"],
            respuestaCorrecta: "Una l√≠nea recta inclinada",
            explicacion: "En MRU, x = x‚ÇÄ + vt es una funci√≥n lineal con pendiente v."
        },
        {
            tema: "MRU",
            question: "Si t = (x - x‚ÇÄ)/v, ¬øpara qu√© sirve esta ecuaci√≥n?",
            opciones: ["Calcular velocidad", "Calcular tiempo", "Calcular aceleraci√≥n", "Calcular fuerza"],
            respuestaCorrecta: "Calcular tiempo",
            explicacion: "Es el despeje de la ecuaci√≥n de MRU para encontrar el tiempo."
        },
        {
            tema: "MRU",
            question: "Un tren viaja a 80 km/h. ¬øCu√°nto tiempo tarda en recorrer 240 km?",
            opciones: ["2 horas", "3 horas", "4 horas", "5 horas"],
            respuestaCorrecta: "3 horas",
            explicacion: "t = x/v = 240 km / 80 km/h = 3 horas"
        },
        {
            tema: "MRU",
            question: "¬øQu√© significa que la velocidad sea constante?",
            opciones: [
                "Solo la magnitud es constante",
                "Solo la direcci√≥n es constante", 
                "Tanto magnitud como direcci√≥n son constantes",
                "Que no hay movimiento"
            ],
            respuestaCorrecta: "Tanto magnitud como direcci√≥n son constantes",
            explicacion: "Velocidad constante implica que no cambia ni su magnitud ni su direcci√≥n."
        },
        {
            tema: "MRU",
            question: "Si x‚ÇÄ = 10 m, v = 5 m/s y t = 4 s, ¬øcu√°l es la posici√≥n final?",
            opciones: ["30 m", "20 m", "25 m", "35 m"],
            respuestaCorrecta: "30 m",
            explicacion: "x = x‚ÇÄ + vt = 10 + 5(4) = 10 + 20 = 30 m"
        },
        {
            tema: "MRU",
            question: "En MRU, ¬øla distancia recorrida es igual al desplazamiento?",
            opciones: [
                "Siempre",
                "Solo si no hay cambio de direcci√≥n",
                "Nunca",
                "Solo en movimiento circular"
            ],
            respuestaCorrecta: "Solo si no hay cambio de direcci√≥n",
            explicacion: "En MRU rectil√≠neo sin cambio de sentido, distancia = |desplazamiento|."
        }
    ],

    // ============================================
    // üöÄ TEMA 4: MOVIMIENTO RECTIL√çNEO UNIFORMEMENTE ACELERADO - MRUA (15 preguntas)
    // ============================================
    mrua: [
        {
            tema: "MRUA",
            question: "En MRUA, ¬øc√≥mo es la aceleraci√≥n?",
            opciones: ["Variable", "Constante", "Cero", "Infinita"],
            respuestaCorrecta: "Constante",
            explicacion: "En MRUA, la aceleraci√≥n permanece constante durante todo el movimiento."
        },
        {
            tema: "MRUA",
            question: "¬øCu√°l es la ecuaci√≥n correcta v = v‚ÇÄ + at?",
            opciones: ["Velocidad final", "Velocidad inicial", "Aceleraci√≥n", "Todas son correctas"],
            respuestaCorrecta: "Todas son correctas",
            explicacion: "Esta ecuaci√≥n relaciona velocidad final, inicial, aceleraci√≥n y tiempo."
        },
        {
            tema: "MRUA",
            question: "¬øCu√°l es la ecuaci√≥n para posici√≥n en MRUA?",
            opciones: ["x = vt", "x = x‚ÇÄ + v‚ÇÄt + ¬Ωat¬≤", "x = ¬Ωat", "x = v‚ÇÄ + at"],
            respuestaCorrecta: "x = x‚ÇÄ + v‚ÇÄt + ¬Ωat¬≤",
            explicacion: "Esta es la ecuaci√≥n cinem√°tica para posici√≥n en MRUA."
        },
        {
            tema: "MRUA",
            question: "¬øCu√°l es la ecuaci√≥n que NO involucra el tiempo?",
            opciones: ["v = v‚ÇÄ + at", "x = v‚ÇÄt + ¬Ωat¬≤", "v¬≤ = v‚ÇÄ¬≤ + 2ax", "x = (v + v‚ÇÄ)t/2"],
            respuestaCorrecta: "v¬≤ = v‚ÇÄ¬≤ + 2ax",
            explicacion: "Esta ecuaci√≥n relaciona velocidades, aceleraci√≥n y desplazamiento sin tiempo."
        },
        {
            tema: "MRUA",
            question: "¬øQu√© representa la ecuaci√≥n x = (v + v‚ÇÄ)t/2?",
            opciones: ["Velocidad promedio", "Posici√≥n usando velocidad promedio", "Aceleraci√≥n", "Tiempo"],
            respuestaCorrecta: "Posici√≥n usando velocidad promedio",
            explicacion: "Usa el hecho de que en MRUA, v_promedio = (v + v‚ÇÄ)/2."
        },
        {
            tema: "MRUA",
            question: "Si a = (v - v‚ÇÄ)/t, ¬øqu√© estamos calculando?",
            opciones: ["Velocidad", "Posici√≥n", "Aceleraci√≥n", "Tiempo"],
            respuestaCorrecta: "Aceleraci√≥n",
            explicacion: "Es la definici√≥n de aceleraci√≥n: cambio de velocidad sobre tiempo."
        },
        {
            tema: "MRUA",
            question: "Un objeto acelera desde reposo a 2 m/s¬≤ durante 5 s. ¬øCu√°l es su velocidad final?",
            opciones: ["7 m/s", "10 m/s", "12 m/s", "2.5 m/s"],
            respuestaCorrecta: "10 m/s",
            explicacion: "v = v‚ÇÄ + at = 0 + 2(5) = 10 m/s"
        },
        {
            tema: "MRUA",
            question: "¬øCu√°nta distancia recorre el objeto del problema anterior?",
            opciones: ["25 m", "50 m", "10 m", "20 m"],
            respuestaCorrecta: "25 m",
            explicacion: "x = v‚ÇÄt + ¬Ωat¬≤ = 0 + ¬Ω(2)(5¬≤) = 25 m"
        },
        {
            tema: "MRUA",
            question: "¬øC√≥mo es la gr√°fica velocidad vs. tiempo en MRUA?",
            opciones: ["L√≠nea horizontal", "L√≠nea recta inclinada", "Par√°bola", "Curva exponencial"],
            respuestaCorrecta: "L√≠nea recta inclinada",
            explicacion: "v = v‚ÇÄ + at es una funci√≥n lineal con pendiente a."
        },
        {
            tema: "MRUA",
            question: "¬øC√≥mo es la gr√°fica posici√≥n vs. tiempo en MRUA?",
            opciones: ["L√≠nea recta", "Par√°bola", "C√≠rculo", "L√≠nea horizontal"],
            respuestaCorrecta: "Par√°bola",
            explicacion: "x = x‚ÇÄ + v‚ÇÄt + ¬Ωat¬≤ es una funci√≥n cuadr√°tica."
        },
        {
            tema: "MRUA",
            question: "Un auto frena con a = -3 m/s¬≤ desde 30 m/s. ¬øCu√°nto tarda en detenerse?",
            opciones: ["10 s", "15 s", "5 s", "20 s"],
            respuestaCorrecta: "10 s",
            explicacion: "0 = 30 + (-3)t ‚Üí t = 30/3 = 10 s"
        },
        {
            tema: "MRUA",
            question: "¬øQu√© distancia recorre el auto al frenar del problema anterior?",
            opciones: ["150 m", "300 m", "450 m", "90 m"],
            respuestaCorrecta: "150 m",
            explicacion: "v¬≤ = v‚ÇÄ¬≤ + 2ax ‚Üí 0 = 900 + 2(-3)x ‚Üí x = 150 m"
        },
        {
            tema: "MRUA",
            question: "¬øCu√°l es la velocidad promedio en MRUA?",
            opciones: ["v‚ÇÄ", "v", "(v + v‚ÇÄ)/2", "at"],
            respuestaCorrecta: "(v + v‚ÇÄ)/2",
            explicacion: "En MRUA, la velocidad promedio es la media aritm√©tica de velocidades inicial y final."
        },
        {
            tema: "MRUA",
            question: "Si un objeto parte del reposo y acelera a 4 m/s¬≤, ¬øqu√© velocidad tiene a los 3 s?",
            opciones: ["12 m/s", "7 m/s", "4 m/s", "16 m/s"],
            respuestaCorrecta: "12 m/s",
            explicacion: "v = v‚ÇÄ + at = 0 + 4(3) = 12 m/s"
        },
        {
            tema: "MRUA",
            question: "¬øCu√°l es la diferencia principal entre MRU y MRUA?",
            opciones: [
                "La velocidad inicial",
                "La presencia de aceleraci√≥n constante",
                "El tiempo de movimiento",
                "La direcci√≥n"
            ],
            respuestaCorrecta: "La presencia de aceleraci√≥n constante",
            explicacion: "En MRU a=0, en MRUA a=constante‚â†0."
        }
    ],

    // ============================================
    // üåç TEMA 5: MOVIMIENTO VERTICAL Y GRAVEDAD (15 preguntas)
    // ============================================
    vertical: [
        {
            tema: "Movimiento Vertical",
            question: "¬øCu√°l es el valor aproximado de la aceleraci√≥n gravitatoria en la Tierra?",
            opciones: ["9.8 m/s¬≤", "10 m/s¬≤", "8.9 m/s¬≤", "11 m/s¬≤"],
            respuestaCorrecta: "9.8 m/s¬≤",
            explicacion: "La aceleraci√≥n gravitatoria terrestre es g = 9.8 m/s¬≤ hacia abajo."
        },
        {
            tema: "Movimiento Vertical",
            question: "En ca√≠da libre, ¬øc√≥mo es la aceleraci√≥n?",
            opciones: ["Variable", "Cero", "Constante e igual a g", "Depende de la masa"],
            respuestaCorrecta: "Constante e igual a g",
            explicacion: "En ca√≠da libre, todos los objetos tienen aceleraci√≥n g, independiente de su masa."
        },
        {
            tema: "Movimiento Vertical",
            question: "Un objeto se lanza verticalmente hacia arriba. En el punto m√°s alto:",
            opciones: ["v = 0, a = 0", "v = 0, a = g", "v = m√°xima, a = 0", "v = g, a = 0"],
            respuestaCorrecta: "v = 0, a = g",
            explicacion: "En el punto m√°s alto, la velocidad es cero pero la aceleraci√≥n sigue siendo g."
        },
        {
            tema: "Movimiento Vertical",
            question: "¬øCu√°nto tiempo tarda un objeto en caer desde 45 m de altura?",
            opciones: ["3 s", "4 s", "2 s", "5 s"],
            respuestaCorrecta: "3 s",
            explicacion: "h = ¬Ωgt¬≤ ‚Üí 45 = ¬Ω(10)t¬≤ ‚Üí t¬≤ = 9 ‚Üí t = 3 s (usando g ‚âà 10 m/s¬≤)"
        },
        {
            tema: "Movimiento Vertical",
            question: "¬øCon qu√© velocidad llega al suelo el objeto del problema anterior?",
            opciones: ["30 m/s", "45 m/s", "20 m/s", "15 m/s"],
            respuestaCorrecta: "30 m/s",
            explicacion: "v = gt = 10(3) = 30 m/s"
        },
        {
            tema: "Movimiento Vertical",
            question: "Un objeto se lanza hacia arriba con v‚ÇÄ = 20 m/s. ¬øCu√°l es su altura m√°xima?",
            opciones: ["20 m", "40 m", "10 m", "30 m"],
            respuestaCorrecta: "20 m",
            explicacion: "v¬≤ = v‚ÇÄ¬≤ - 2gh ‚Üí 0 = 400 - 2(10)h ‚Üí h = 20 m"
        },
        {
            tema: "Movimiento Vertical",
            question: "¬øCu√°nto tiempo tarda en subir el objeto del problema anterior?",
            opciones: ["2 s", "4 s", "1 s", "3 s"],
            respuestaCorrecta: "2 s",
            explicacion: "v = v‚ÇÄ - gt ‚Üí 0 = 20 - 10t ‚Üí t = 2 s"
        },
        {
            tema: "Movimiento Vertical",
            question: "¬øCu√°nto tiempo total est√° en el aire el objeto lanzado hacia arriba?",
            opciones: ["2 s", "4 s", "6 s", "8 s"],
            respuestaCorrecta: "4 s",
            explicacion: "El tiempo total es el doble del tiempo de subida: 2 √ó 2 = 4 s"
        },
        {
            tema: "Movimiento Vertical",
            question: "En ausencia de resistencia del aire, ¬øqu√© objeto cae m√°s r√°pido?",
            opciones: ["El m√°s pesado", "El m√°s liviano", "Ambos igual", "Depende de la forma"],
            respuestaCorrecta: "Ambos igual",
            explicacion: "En el vac√≠o, todos los objetos caen con la misma aceleraci√≥n g."
        },
        {
            tema: "Movimiento Vertical",
            question: "¬øCu√°l es la ecuaci√≥n para la altura en ca√≠da libre desde el reposo?",
            opciones: ["h = vt", "h = ¬Ωgt¬≤", "h = gt", "h = v‚ÇÄt + ¬Ωgt¬≤"],
            respuestaCorrecta: "h = ¬Ωgt¬≤",
            explicacion: "Para ca√≠da libre desde reposo (v‚ÇÄ = 0): h = ¬Ωgt¬≤"
        },
        {
            tema: "Movimiento Vertical",
            question: "¬øQu√© es la ca√≠da libre?",
            opciones: [
                "Cualquier movimiento hacia abajo",
                "Movimiento bajo la acci√≥n √∫nica de la gravedad",
                "Movimiento con velocidad constante",
                "Solo cuando se suelta desde reposo"
            ],
            respuestaCorrecta: "Movimiento bajo la acci√≥n √∫nica de la gravedad",
            explicacion: "Ca√≠da libre es movimiento donde solo act√∫a la gravedad (sin resistencia del aire)."
        },
        {
            tema: "Movimiento Vertical",
            question: "Un objeto cae durante 4 s. ¬øQu√© distancia recorre?",
            opciones: ["80 m", "160 m", "40 m", "120 m"],
            respuestaCorrecta: "80 m",
            explicacion: "h = ¬Ωgt¬≤ = ¬Ω(10)(4¬≤) = ¬Ω(10)(16) = 80 m"
        },
        {
            tema: "Movimiento Vertical",
            question: "¬øPor qu√© g se considera negativa en lanzamiento vertical?",
            opciones: [
                "Porque es hacia abajo",
                "Por convenio de signos",
                "Porque frena el movimiento ascendente",
                "Todas las anteriores"
            ],
            respuestaCorrecta: "Todas las anteriores",
            explicacion: "g es negativa por convenio cuando el eje y es positivo hacia arriba."
        },
        {
            tema: "Movimiento Vertical",
            question: "¬øCon qu√© velocidad debe lanzarse un objeto para que alcance 80 m de altura?",
            opciones: ["40 m/s", "20 m/s", "30 m/s", "50 m/s"],
            respuestaCorrecta: "40 m/s",
            explicacion: "v‚ÇÄ¬≤ = 2gh = 2(10)(80) = 1600 ‚Üí v‚ÇÄ = 40 m/s"
        },
        {
            tema: "Movimiento Vertical",
            question: "¬øQu√© velocidad tiene un objeto despu√©s de caer 20 m?",
            opciones: ["20 m/s", "30 m/s", "40 m/s", "10 m/s"],
            respuestaCorrecta: "20 m/s",
            explicacion: "v¬≤ = 2gh = 2(10)(20) = 400 ‚Üí v = 20 m/s"
        }
    ],

    // ============================================
    // üîÑ TEMA 6: MOVIMIENTO CIRCULAR UNIFORME (15 preguntas)
    // ============================================
    circular: [
        {
            tema: "Movimiento Circular",
            question: "¬øC√≥mo se define el √°ngulo en radianes?",
            opciones: ["Œ∏ = s/r", "Œ∏ = r/s", "Œ∏ = s√ór", "Œ∏ = 2œÄr"],
            respuestaCorrecta: "Œ∏ = s/r",
            explicacion: "El √°ngulo en radianes es la raz√≥n entre el arco y el radio."
        },
        {
            tema: "Movimiento Circular",
            question: "¬øCu√°ntos radianes hay en una vuelta completa?",
            opciones: ["œÄ", "2œÄ", "œÄ/2", "4œÄ"],
            respuestaCorrecta: "2œÄ",
            explicacion: "Una vuelta completa corresponde a 2œÄ radianes = 360¬∞."
        },
        {
            tema: "Movimiento Circular",
            question: "¬øCu√°l es la ecuaci√≥n de velocidad lineal en MCU?",
            opciones: ["v = œâr", "v = œâ/r", "v = r/œâ", "v = œâ¬≤r"],
            respuestaCorrecta: "v = œâr",
            explicacion: "La velocidad lineal es el producto de velocidad angular por radio."
        },
        {
            tema: "Movimiento Circular",
            question: "¬øC√≥mo se define la velocidad angular?",
            opciones: ["œâ = Œ∏/t", "œâ = t/Œ∏", "œâ = Œ∏√ót", "œâ = r/t"],
            respuestaCorrecta: "œâ = Œ∏/t",
            explicacion: "Velocidad angular es el √°ngulo recorrido por unidad de tiempo."
        },
        {
            tema: "Movimiento Circular",
            question: "¬øCu√°l es la relaci√≥n entre velocidad angular y per√≠odo?",
            opciones: ["œâ = T", "œâ = 2œÄ/T", "œâ = œÄ/T", "œâ = T/2œÄ"],
            respuestaCorrecta: "œâ = 2œÄ/T",
            explicacion: "En un per√≠odo T se recorre 2œÄ radianes, entonces œâ = 2œÄ/T."
        },
        {
            tema: "Movimiento Circular",
            question: "¬øQu√© es el per√≠odo T en MCU?",
            opciones: [
                "El tiempo para recorrer medio c√≠rculo",
                "El tiempo para una vuelta completa",
                "La velocidad angular",
                "El radio del c√≠rculo"
            ],
            respuestaCorrecta: "El tiempo para una vuelta completa",
            explicacion: "El per√≠odo es el tiempo que tarda en completar una revoluci√≥n."
        },
        {
            tema: "Movimiento Circular",
            question: "¬øC√≥mo se define la frecuencia f?",
            opciones: ["f = T", "f = 1/T", "f = 2œÄT", "f = T/2œÄ"],
            respuestaCorrecta: "f = 1/T",
            explicacion: "La frecuencia es el n√∫mero de vueltas por unidad de tiempo: f = 1/T."
        },
        {
            tema: "Movimiento Circular",
            question: "¬øCu√°l es la unidad SI de velocidad angular?",
            opciones: ["rad", "rad/s", "Hz", "rpm"],
            respuestaCorrecta: "rad/s",
            explicacion: "La velocidad angular se mide en radianes por segundo."
        },
        {
            tema: "Movimiento Circular",
            question: "¬øHacia d√≥nde apunta la aceleraci√≥n centr√≠peta?",
            opciones: ["Tangente al c√≠rculo", "Hacia el centro", "Hacia afuera", "Variable"],
            respuestaCorrecta: "Hacia el centro",
            explicacion: "La aceleraci√≥n centr√≠peta siempre apunta hacia el centro del c√≠rculo."
        },
        {
            tema: "Movimiento Circular",
            question: "¬øCu√°l es la f√≥rmula de aceleraci√≥n centr√≠peta?",
            opciones: ["ac = v¬≤/r", "ac = vr", "ac = v/r", "ac = r/v"],
            respuestaCorrecta: "ac = v¬≤/r",
            explicacion: "La aceleraci√≥n centr√≠peta es ac = v¬≤/r = œâ¬≤r."
        },
        {
            tema: "Movimiento Circular",
            question: "Un objeto gira con œâ = 4 rad/s en un c√≠rculo de r = 2 m. ¬øCu√°l es su velocidad lineal?",
            opciones: ["2 m/s", "8 m/s", "6 m/s", "4 m/s"],
            respuestaCorrecta: "8 m/s",
            explicacion: "v = œâr = 4 √ó 2 = 8 m/s"
        },
        {
            tema: "Movimiento Circular",
            question: "¬øCu√°l es la aceleraci√≥n centr√≠peta del objeto anterior?",
            opciones: ["16 m/s¬≤", "32 m/s¬≤", "8 m/s¬≤", "24 m/s¬≤"],
            respuestaCorrecta: "32 m/s¬≤",
            explicacion: "ac = v¬≤/r = 8¬≤/2 = 64/2 = 32 m/s¬≤ o ac = œâ¬≤r = 4¬≤√ó2 = 32 m/s¬≤"
        },
        {
            tema: "Movimiento Circular",
            question: "Si T = 4 s, ¬øcu√°l es la frecuencia?",
            opciones: ["4 Hz", "0.25 Hz", "2 Hz", "8 Hz"],
            respuestaCorrecta: "0.25 Hz",
            explicacion: "f = 1/T = 1/4 = 0.25 Hz"
        },
        {
            tema: "Movimiento Circular",
            question: "¬øCu√°l es la velocidad angular si T = 2 s?",
            opciones: ["œÄ rad/s", "2œÄ rad/s", "œÄ/2 rad/s", "4œÄ rad/s"],
            respuestaCorrecta: "œÄ rad/s",
            explicacion: "œâ = 2œÄ/T = 2œÄ/2 = œÄ rad/s"
        },
        {
            tema: "Movimiento Circular",
            question: "En MCU, ¬øcambia la velocidad?",
            opciones: [
                "No cambia nada",
                "Cambia la direcci√≥n pero no la magnitud",
                "Cambia la magnitud pero no la direcci√≥n",
                "Cambian ambas"
            ],
            respuestaCorrecta: "Cambia la direcci√≥n pero no la magnitud",
            explicacion: "En MCU, |v| = constante pero la direcci√≥n cambia continuamente."
        }
    ],

    // ============================================
    // üìä TEMA 7: MOVIMIENTO PARAB√ìLICO (15 preguntas)
    // ============================================
    parabolico: [
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øC√≥mo es el movimiento en el eje horizontal en tiro parab√≥lico?",
            opciones: ["MRU", "MRUA", "Circular", "Variable"],
            respuestaCorrecta: "MRU",
            explicacion: "En el eje x no hay aceleraci√≥n, por lo tanto es MRU: x = v‚ÇÄ‚Çìt"
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øC√≥mo es el movimiento en el eje vertical en tiro parab√≥lico?",
            opciones: ["MRU", "MRUA", "Circular", "Sin movimiento"],
            respuestaCorrecta: "MRUA",
            explicacion: "En el eje y act√∫a la gravedad, generando MRUA con a = -g."
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øCu√°les son las componentes de velocidad inicial con √°ngulo Œ∏?",
            opciones: [
                "v‚ÇÄ‚Çì = v‚ÇÄsenŒ∏, v‚ÇÄ·µß = v‚ÇÄcosŒ∏",
                "v‚ÇÄ‚Çì = v‚ÇÄcosŒ∏, v‚ÇÄ·µß = v‚ÇÄsenŒ∏",
                "v‚ÇÄ‚Çì = v‚ÇÄtanŒ∏, v‚ÇÄ·µß = v‚ÇÄ",
                "v‚ÇÄ‚Çì = v‚ÇÄ, v‚ÇÄ·µß = v‚ÇÄtanŒ∏"
            ],
            respuestaCorrecta: "v‚ÇÄ‚Çì = v‚ÇÄcosŒ∏, v‚ÇÄ·µß = v‚ÇÄsenŒ∏",
            explicacion: "La componente horizontal es v‚ÇÄcosŒ∏ y la vertical es v‚ÇÄsenŒ∏."
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øCu√°l es el tiempo de vuelo para un proyectil lanzado desde el suelo?",
            opciones: ["t = v‚ÇÄ/g", "t = 2v‚ÇÄsenŒ∏/g", "t = v‚ÇÄsenŒ∏/g", "t = v‚ÇÄcosŒ∏/g"],
            respuestaCorrecta: "t = 2v‚ÇÄsenŒ∏/g",
            explicacion: "El tiempo de vuelo es el doble del tiempo para alcanzar la altura m√°xima."
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øCu√°l es la altura m√°xima en tiro parab√≥lico?",
            opciones: [
                "h = v‚ÇÄ¬≤/2g",
                "h = v‚ÇÄ¬≤sen¬≤Œ∏/2g",
                "h = v‚ÇÄ¬≤cos¬≤Œ∏/2g",
                "h = v‚ÇÄ¬≤tan¬≤Œ∏/2g"
            ],
            respuestaCorrecta: "h = v‚ÇÄ¬≤sen¬≤Œ∏/2g",
            explicacion: "La altura m√°xima depende solo de la componente vertical inicial."
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øCu√°l es el alcance horizontal m√°ximo?",
            opciones: [
                "R = v‚ÇÄ¬≤/g",
                "R = v‚ÇÄ¬≤sen2Œ∏/g",
                "R = v‚ÇÄ¬≤cos2Œ∏/g",
                "R = 2v‚ÇÄ¬≤senŒ∏/g"
            ],
            respuestaCorrecta: "R = v‚ÇÄ¬≤sen2Œ∏/g",
            explicacion: "El alcance horizontal es R = v‚ÇÄ¬≤sen2Œ∏/g."
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øCon qu√© √°ngulo se obtiene el alcance m√°ximo?",
            opciones: ["30¬∞", "45¬∞", "60¬∞", "90¬∞"],
            respuestaCorrecta: "45¬∞",
            explicacion: "sen2Œ∏ es m√°ximo cuando 2Œ∏ = 90¬∞, es decir Œ∏ = 45¬∞."
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øCu√°ndo la velocidad es m√≠nima en tiro parab√≥lico?",
            opciones: [
                "Al inicio",
                "En el punto m√°s alto",
                "Al final",
                "A la mitad del recorrido"
            ],
            respuestaCorrecta: "En el punto m√°s alto",
            explicacion: "En el punto m√°s alto, v·µß = 0, quedando solo v‚Çì = v‚ÇÄcosŒ∏."
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øQu√© forma tiene la trayectoria en tiro parab√≥lico?",
            opciones: ["L√≠nea recta", "C√≠rculo", "Par√°bola", "Elipse"],
            respuestaCorrecta: "Par√°bola",
            explicacion: "La ecuaci√≥n de trayectoria es y = xtanŒ∏ - gx¬≤/(2v‚ÇÄ¬≤cos¬≤Œ∏), que es una par√°bola."
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "Un proyectil se lanza a 20 m/s con 30¬∞. ¬øCu√°l es v‚ÇÄ‚Çì?",
            opciones: ["10 m/s", "17.3 m/s", "20 m/s", "15 m/s"],
            respuestaCorrecta: "17.3 m/s",
            explicacion: "v‚ÇÄ‚Çì = v‚ÇÄcos30¬∞ = 20 √ó 0.866 = 17.3 m/s"
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øCu√°l es v‚ÇÄ·µß del proyectil anterior?",
            opciones: ["10 m/s", "17.3 m/s", "20 m/s", "15 m/s"],
            respuestaCorrecta: "10 m/s",
            explicacion: "v‚ÇÄ·µß = v‚ÇÄsen30¬∞ = 20 √ó 0.5 = 10 m/s"
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øCu√°nto tiempo tarda en alcanzar la altura m√°xima el proyectil anterior?",
            opciones: ["1 s", "2 s", "0.5 s", "1.5 s"],
            respuestaCorrecta: "1 s",
            explicacion: "t = v‚ÇÄ·µß/g = 10/10 = 1 s (usando g = 10 m/s¬≤)"
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øCu√°l es la altura m√°xima del proyectil anterior?",
            opciones: ["5 m", "10 m", "2.5 m", "7.5 m"],
            respuestaCorrecta: "5 m",
            explicacion: "h = v‚ÇÄ·µß¬≤/2g = 10¬≤/(2√ó10) = 100/20 = 5 m"
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øCu√°l es el tiempo total de vuelo del proyectil anterior?",
            opciones: ["1 s", "2 s", "3 s", "4 s"],
            respuestaCorrecta: "2 s",
            explicacion: "Tiempo total = 2 √ó tiempo de subida = 2 √ó 1 = 2 s"
        },
        {
            tema: "Movimiento Parab√≥lico",
            question: "¬øCu√°l es el alcance horizontal del proyectil anterior?",
            opciones: ["34.6 m", "20 m", "30 m", "40 m"],
            respuestaCorrecta: "34.6 m",
            explicacion: "R = v‚ÇÄ‚Çì √ó t_total = 17.3 √ó 2 = 34.6 m"
        }
    ]
};

// ===============================================================
// üéØ CONFIGURACI√ìN DE NIVELES CON PREGUNTAS ESPEC√çFICAS
// ===============================================================
const LEVEL_QUESTIONS = {
    easy: {
        temas: ["magnitudes", "cinematica"],
        distribucion: {
            magnitudes: 8,      // 8 preguntas de magnitudes
            cinematica: 4       // 4 preguntas de cinem√°tica b√°sica
        }
    },
    medium: {
        temas: ["mru", "mrua"],
        distribucion: {
            mru: 8,             // 8 preguntas de MRU
            mrua: 8             // 8 preguntas de MRUA
        }
    },
    hard: {
        temas: ["mrua", "vertical"],
        distribucion: {
            mrua: 7,            // 7 preguntas de MRUA
            vertical: 13        // 13 preguntas de movimiento vertical
        }
    },
    expert: {
        temas: ["circular", "parabolico"],
        distribucion: {
            circular: 12,       // 12 preguntas de movimiento circular
            parabolico: 13      // 13 preguntas de movimiento parab√≥lico
        }
    }
};

// ===============================================================
// üéÆ ESTADO GLOBAL DEL JUEGO - INICIALIZACI√ìN
// ===============================================================
const gameState = {
    // Estado del juego
    level: "easy",
    gameStarted: false,
    gameCompleted: false,
    paused: false,
    
    // Posiciones y elementos
    playerPosition: { x: 1, y: 1 },
    playerDirection: "right",
    fruits: [],
    walls: [],
    ghosts: [],
    pacmanEl: null,
    
    // Puntuaci√≥n y progreso
    score: 0,
    lives: GAME_CONFIG.MAX_LIVES,
    fruitCollected: 0,
    totalFruits: 0,
    questionsAnswered: 0,
    totalQuestionsInLevel: 0,
    correctAnswers: 0,
    
    // Sistema de preguntas
    currentQuestion: null,
    questionPool: {},
    usedQuestions: [],
    
    // Configuraci√≥n din√°mica
    mazeWidth: 0,
    mazeHeight: 0,
    finalGrade: 0,
    
    // Temporizadores y intervalos
    ghostMovementInterval: null,
    vulnerableGhostsTimer: null,
    questionStartTime: null,
    
    // Estados especiales
    ghostsVulnerable: false,
    powerPelletActive: false
};

// ===============================================================
// üìã CONFIGURACI√ìN DEL LABERINTO - MEJORADA
// ===============================================================
const mazeLayout = {
    width: 17,  // Incrementado para m√°s espacio
    height: 11, // Incrementado para m√°s espacio
    walls: [
        // Bordes externos
        ...Array.from({ length: 17 }, (_, i) => ({ x: i, y: 0 })),
        ...Array.from({ length: 17 }, (_, i) => ({ x: i, y: 10 })),
        ...Array.from({ length: 9 }, (_, i) => ({ x: 0, y: i + 1 })),
        ...Array.from({ length: 9 }, (_, i) => ({ x: 16, y: i + 1 })),
        
        // Laberinto interno - patr√≥n mejorado
        { x: 2, y: 2 }, { x: 3, y: 2 }, { x: 4, y: 2 }, 
        { x: 6, y: 2 }, { x: 7, y: 2 }, { x: 8, y: 2 }, { x: 9, y: 2 }, { x: 10, y: 2 },
        { x: 12, y: 2 }, { x: 13, y: 2 }, { x: 14, y: 2 },
        
        { x: 2, y: 4 }, { x: 4, y: 4 }, { x: 6, y: 4 }, { x: 10, y: 4 }, { x: 12, y: 4 }, { x: 14, y: 4 },
        
        { x: 2, y: 6 }, { x: 4, y: 6 }, { x: 6, y: 6 }, { x: 10, y: 6 }, { x: 12, y: 6 }, { x: 14, y: 6 },
        
        { x: 2, y: 8 }, { x: 3, y: 8 }, { x: 4, y: 8 },
        { x: 6, y: 8 }, { x: 7, y: 8 }, { x: 8, y: 8 }, { x: 9, y: 8 }, { x: 10, y: 8 },
        { x: 12, y: 8 }, { x: 13, y: 8 }, { x: 14, y: 8 }
    ],
    
    // Posiciones de frutas/power pellets - distribuidas estrat√©gicamente
    fruits: [
        { x: 1, y: 1 }, { x: 5, y: 1 }, { x: 8, y: 1 }, { x: 11, y: 1 }, { x: 15, y: 1 },
        { x: 1, y: 3 }, { x: 3, y: 3 }, { x: 5, y: 3 }, { x: 8, y: 3 }, { x: 11, y: 3 }, { x: 13, y: 3 }, { x: 15, y: 3 },
        { x: 1, y: 5 }, { x: 3, y: 5 }, { x: 5, y: 5 }, { x: 8, y: 5 }, { x: 11, y: 5 }, { x: 13, y: 5 }, { x: 15, y: 5 },
        { x: 1, y: 7 }, { x: 5, y: 7 }, { x: 8, y: 7 }, { x: 11, y: 7 }, { x: 15, y: 7 },
        { x: 1, y: 9 }, { x: 5, y: 9 }, { x: 8, y: 9 }, { x: 11, y: 9 }, { x: 15, y: 9 }
    ]
};

// Usar el mismo laberinto para todos los niveles (se puede personalizar despu√©s)
const mazeConfigs = {
    easy: mazeLayout,
    medium: mazeLayout,
    hard: mazeLayout,
    expert: mazeLayout
};

// ===============================================================
// üîß FUNCIONES UTILITARIAS DEL JUEGO
// ===============================================================

/**
 * Inicializa el pool de preguntas por nivel
 * Selecciona preguntas espec√≠ficas seg√∫n la configuraci√≥n del nivel
 */
function initializeQuestionPool() {
    console.log(`üéØ Inicializando pool de preguntas para nivel: ${gameState.level}`);
    
    const levelConfig = LEVEL_QUESTIONS[gameState.level];
    const selectedQuestions = [];
    
    // Seleccionar preguntas seg√∫n distribuci√≥n del nivel
    levelConfig.temas.forEach(tema => {
        const cantidadRequerida = levelConfig.distribucion[tema];
        const preguntasDelTema = QUESTION_BANK[tema] || [];
        
        // Mezclar preguntas del tema
        const preguntasMezcladas = [...preguntasDelTema].sort(() => Math.random() - 0.5);
        
        // Tomar la cantidad requerida
        const preguntasSeleccionadas = preguntasMezcladas.slice(0, cantidadRequerida);
        selectedQuestions.push(...preguntasSeleccionadas);
        
        console.log(`üìö ${tema}: ${preguntasSeleccionadas.length}/${cantidadRequerida} preguntas`);
    });
    
    // Mezclar todas las preguntas seleccionadas
    gameState.questionPool = selectedQuestions.sort(() => Math.random() - 0.5);
    gameState.totalQuestionsInLevel = gameState.questionPool.length;
    gameState.usedQuestions = [];
    
    console.log(`‚úÖ Pool inicializado: ${gameState.totalQuestionsInLevel} preguntas totales`);
}

/**
 * Obtiene la pr√≥xima pregunta disponible
 * @returns {Object|null} Pregunta o null si no hay m√°s
 */
function getNextQuestion() {
    if (gameState.questionPool.length === 0) {
        console.log("‚ö†Ô∏è No hay m√°s preguntas disponibles");
        return null;
    }
    
    const question = gameState.questionPool.pop();
    gameState.usedQuestions.push(question);
    
    console.log(`‚ùì Pregunta obtenida: ${question.tema} - ${question.question.substring(0, 50)}...`);
    return question;
}

/**
 * Calcula la calificaci√≥n final del estudiante
 * @returns {number} Calificaci√≥n entre 0 y 5
 */
function calculateFinalGrade() {
    const totalQuestions = gameState.totalQuestionsInLevel;
    const correctAnswers = gameState.correctAnswers;
    const livesLost = GAME_CONFIG.MAX_LIVES - gameState.lives;
    
    if (totalQuestions === 0) {
        return 0;
    }
    
    // Porcentaje de respuestas correctas (0-1)
    const accuracyRatio = correctAnswers / totalQuestions;
    
    // Penalizaci√≥n por vidas perdidas (m√°ximo 1 punto de penalizaci√≥n)
    const lifePenalty = Math.min(livesLost * 0.125, 1.0); // 0.125 por vida perdida
    
    // Calificaci√≥n base sobre 5
    let grade = accuracyRatio * 5.0;
    
    // Aplicar penalizaci√≥n
    grade = Math.max(0, grade - lifePenalty);
    
    // Bonus por completar el nivel
    if (gameState.fruitCollected === gameState.totalFruits) {
        grade += 0.2; // Bonus de 0.2 puntos por completar
    }
    
    // Asegurar que est√© entre 0 y 5
    grade = Math.min(5.0, Math.max(0, grade));
    
    console.log(`üìä Calificaci√≥n calculada: ${grade.toFixed(1)}/5.0`);
    console.log(`   - Correctas: ${correctAnswers}/${totalQuestions} (${(accuracyRatio*100).toFixed(1)}%)`);
    console.log(`   - Vidas perdidas: ${livesLost}`);
    console.log(`   - Penalizaci√≥n: ${lifePenalty.toFixed(2)}`);
    
    return grade;
}

/**
 * Obtiene mensaje motivacional seg√∫n la calificaci√≥n
 * @param {number} grade Calificaci√≥n entre 0 y 5
 * @returns {string} Mensaje motivacional
 */
function getFinalMessage(grade) {
    if (grade >= 4.7) {
        return "üèÜ ¬°EXCELENTE! Dominas completamente estos conceptos de f√≠sica. ¬°Eres un verdadero cient√≠fico!";
    } else if (grade >= 4.0) {
        return "üåü ¬°MUY BIEN! Tienes un s√≥lido entendimiento de la f√≠sica. ¬°Sigue as√≠!";
    } else if (grade >= 3.0) {
        return "üëç ¬°BIEN! Entiendes los conceptos b√°sicos. Con un poco m√°s de pr√°ctica ser√°s excelente.";
    } else if (grade >= 2.0) {
        return "üìö Necesitas reforzar algunos conceptos. ¬°No te desanimes, la pr√°ctica hace al maestro!";
    } else {
        return "üí™ ¬°√Ånimo! La f√≠sica requiere pr√°ctica. Revisa los conceptos b√°sicos y vuelve a intentarlo.";
    }
}

/**
 * Obtiene descripci√≥n detallada del nivel
 * @param {string} level Nivel del juego
 * @returns {string} Descripci√≥n del nivel
 */
function getLevelDescription(level) {
    const config = GAME_CONFIG.LEVELS[level];
    const levelQuestions = LEVEL_QUESTIONS[level];
    
    let description = `<p><strong>${config.description}</strong></p>`;
    description += `<p>üìä ${config.questionCount} preguntas | üëª ${config.ghostCount} fantasma(s)</p>`;
    
    // Agregar temas espec√≠ficos
    const temas = levelQuestions.temas.map(tema => {
        const cantidad = levelQuestions.distribucion[tema];
        const nombreTema = {
            magnitudes: "Magnitudes y SI",
            cinematica: "Cinem√°tica b√°sica", 
            mru: "MRU",
            mrua: "MRUA",
            vertical: "Movimiento vertical",
            circular: "Movimiento circular",
            parabolico: "Movimiento parab√≥lico"
        };
        return `${nombreTema[tema]} (${cantidad})`;
    }).join(" + ");
    
    description += `<p class="text-sm">üéØ Temas: ${temas}</p>`;
    
    return description;
}

// ===============================================================
// üì± REFERENCIAS DOM Y DETECCI√ìN DE DISPOSITIVO
// ===============================================================

// Referencias principales a elementos DOM
const appElement = document.getElementById("app");
const questionDialog = document.getElementById("questionDialog");
const questionText = document.getElementById("questionText");
const optionsContainer = document.getElementById("optionsContainer");
const completionDialog = document.getElementById("completionDialog");
const completionTitle = document.getElementById("completionTitle");
const completionDescription = document.getElementById("completionDescription");
const completionStats = document.getElementById("completionStats");
const playAgainBtn = document.getElementById("playAgainBtn");
const toastContainer = document.getElementById("toastContainer");
const helpDialog = document.getElementById("helpDialog");
const closeHelpBtn = document.getElementById("closeHelpBtn");
const globalPauseBtn = document.getElementById("globalPauseBtn");
const globalResetBtn = document.getElementById("globalResetBtn");

// Detecci√≥n de dispositivo m√≥vil
const isMobile = window.matchMedia("(max-width: 768px)").matches;

// ===============================================================
// üéÆ FUNCIONES PRINCIPALES DE INICIALIZACI√ìN
// ===============================================================

/**
 * Renderiza la aplicaci√≥n principal
 */
function renderApp() {
    console.log(`üéÆ Renderizando app - Estado: ${gameState.gameStarted ? 'Juego' : 'Selector'}`);
    
    if (!gameState.gameStarted) {
        renderLevelSelector();
    } else {
        renderGame();
    }
}

/**
 * Renderiza el selector de niveles
 */
function renderLevelSelector() {
    console.log("üéØ Renderizando selector de niveles");
    
    appElement.innerHTML = `
        <div class="level-selector card">
            <h2>Selecciona tu Nivel de Desaf√≠o</h2>
            <p>Explora diferentes temas de f√≠sica mientras juegas. Recolecta frutas üçé para responder preguntas, 
               power pellets üíä para ganar vidas y evita los fantasmas üëª. ¬°Tu conocimiento es tu poder!</p>
            
            <div class="level-tabs">
                <button class="level-tab ${gameState.level === 'easy' ? 'active' : ''}" data-level="easy">
                    ${GAME_CONFIG.LEVELS.easy.name}
                </button>
                <button class="level-tab ${gameState.level === 'medium' ? 'active' : ''}" data-level="medium">
                    ${GAME_CONFIG.LEVELS.medium.name}
                </button>
                <button class="level-tab ${gameState.level === 'hard' ? 'active' : ''}" data-level="hard">
                    ${GAME_CONFIG.LEVELS.hard.name}
                </button>
                <button class="level-tab ${gameState.level === 'expert' ? 'active' : ''}" data-level="expert">
                    ${GAME_CONFIG.LEVELS.expert.name}
                </button>
            </div>
            
            <div class="level-description">
                ${getLevelDescription(gameState.level)}
            </div>
            
            <div id="buttonContainer">
                <button id="startGameBtn" class="button button-primary">
                    üöÄ ¬°Comenzar Aventura F√≠sica!
                </button>
                <button id="helpBtn" class="button button-help">
                    ‚ùì ¬øC√≥mo Jugar?
                </button>
            </div>
        </div>
    `;

    // Agregar event listeners para las pesta√±as de nivel
    document.querySelectorAll(".level-tab").forEach(tab => {
        tab.addEventListener("click", () => {
            const newLevel = tab.getAttribute("data-level");
            if (newLevel !== gameState.level) {
                gameState.level = newLevel;
                console.log(`üîÑ Nivel cambiado a: ${newLevel}`);
                renderLevelSelector(); // Re-renderizar para actualizar descripci√≥n
            }
        });
    });

    // Agregar event listeners para botones
    const startBtn = document.getElementById("startGameBtn");
    const helpBtn = document.getElementById("helpBtn");
    
    if (startBtn) {
        startBtn.addEventListener("click", startGame);
    }
    
    if (helpBtn) {
        helpBtn.addEventListener("click", showHelpDialog);
    }
}

/**
 * Muestra el di√°logo de ayuda
 */
function showHelpDialog() {
    console.log("‚ùì Mostrando di√°logo de ayuda");
    
    // Crear contenido de ayuda din√°mico
    const helpContent = `
        <div class="dialog-content">
            <div class="dialog-header">
                <h2 class="dialog-title">üéÆ ¬øC√≥mo Jugar?</h2>
                <p class="dialog-description">Gu√≠a completa del Laberinto de F√≠sica</p>
            </div>
            <div class="dialog-body">
                <h3>üéØ Objetivo:</h3>
                <p>Controla al Pac-Man üü° para recolectar todas las frutas del laberinto mientras respondes preguntas de f√≠sica y evitas a los fantasmas üëª.</p>
                
                <h3>üïπÔ∏è Controles:</h3>
                <ul>
                    <li><strong>Teclado:</strong> Usa las flechas ‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è para moverte</li>
                    <li><strong>M√≥vil:</strong> Toca los botones direccionales en pantalla</li>
                </ul>
                
                <h3>üéÆ Elementos del Juego:</h3>
                <ul>
                    <li><strong>Frutas üçéüçåüçá:</strong> Al recolectarlas aparece una pregunta de f√≠sica. ¬°Responde correctamente para ganar puntos!</li>
                    <li><strong>Power Pellets üíä:</strong> Te dan una vida extra y temporalmente puedes "comer" fantasmas</li>
                    <li><strong>Fantasmas üëª:</strong> Te persiguen. Si te tocan pierdes una vida</li>
                    <li><strong>Paredes üß±:</strong> Bloquean el paso</li>
                </ul>
                
                <h3>üìä Puntuaci√≥n:</h3>
                <ul>
                    <li>Frutas b√°sicas: +5 puntos</li>
                    <li>Preguntas correctas: +10 a +40 puntos (seg√∫n dificultad)</li>
                    <li>Fantasmas eliminados: +50 puntos</li>
                    <li>Respuestas r√°pidas: +5 puntos bonus</li>
                </ul>
                
                <h3>üèÜ Calificaci√≥n:</h3>
                <p>Tu desempe√±o se eval√∫a de 0 a 5.0 basado en respuestas correctas, vidas conservadas y completaci√≥n del nivel.</p>
                
                <h3>‚ö° Consejos:</h3>
                <ul>
                    <li>Lee cada pregunta cuidadosamente</li>
                    <li>Los power pellets son estrat√©gicos - √∫salos sabiamente</li>
                    <li>Observa los patrones de movimiento de los fantasmas</li>
                    <li>¬°La pr√°ctica mejora tanto tu juego como tu f√≠sica!</li>
                </ul>
            </div>
            <div class="dialog-footer">
                <button id="closeHelpBtn" class="button button-secondary">
                    ‚úÖ ¬°Entendido!
                </button>
            </div>
        </div>
    `;
    
    helpDialog.innerHTML = helpContent;
    helpDialog.style.display = 'flex';
    
    // Agregar event listener al bot√≥n de cerrar
    const closeBtn = helpDialog.querySelector('#closeHelpBtn');
    if (closeBtn) {
        closeBtn.addEventListener("click", () => {
            helpDialog.style.display = 'none';
        });
    }
}

// ===============================================================
// üöÄ FUNCI√ìN DE INICIO DEL JUEGO
// ===============================================================

/**
 * Inicia el juego con el nivel seleccionado
 */
function startGame() {
    console.log(`üöÄ Iniciando juego en nivel: ${gameState.level}`);
    
    // Resetear estado del juego
    gameState.gameStarted = true;
    gameState.gameCompleted = false;
    gameState.paused = false;
    gameState.score = 0;
    gameState.lives = GAME_CONFIG.MAX_LIVES;
    gameState.questionsAnswered = 0;
    gameState.correctAnswers = 0;
    gameState.fruitCollected = 0;
    gameState.ghostsVulnerable = false;
    gameState.powerPelletActive = false;
    
    // Inicializar sistemas
    initializeMaze();
    initializeQuestionPool();
    assignQuestionsAndPellets();
    
    // Renderizar juego
    renderApp();
    
    // Configurar controles
    attachEventHandlers();
    
    // Iniciar movimiento de fantasmas
    if (gameState.ghostMovementInterval) {
        clearInterval(gameState.ghostMovementInterval);
    }
    
    const ghostSpeed = GAME_CONFIG.LEVELS[gameState.level].ghostSpeed;
    gameState.ghostMovementInterval = setInterval(moveGhosts, ghostSpeed);
    
    // Configurar botones globales
    globalPauseBtn.textContent = "‚è∏Ô∏è Pausar";
    globalPauseBtn.disabled = false;
    
    console.log("‚úÖ Juego iniciado correctamente");
}

// ===============================================================
// üìù LOGGING Y DEBUG
// ===============================================================

console.log("üî¨ Laberinto de F√≠sica v3 - Parte 2 cargada exitosamente");
console.log("üìä Estad√≠sticas del banco de preguntas:");
Object.keys(QUESTION_BANK).forEach(tema => {
    console.log(`   - ${tema}: ${QUESTION_BANK[tema].length} preguntas`);
});
console.log(`üìà Total de preguntas: ${Object.values(QUESTION_BANK).reduce((sum, arr) => sum + arr.length, 0)}`);
console.log("‚è≥ Esperando Parte 3: L√≥gica del Juego y Movimiento...");

// ===============================================================
// üîó PREPARACI√ìN PARA SIGUIENTE PARTE
// ===============================================================

// Funciones que se implementar√°n en la Parte 3:
// - renderGame()
// - initializeMaze()
// - assignQuestionsAndPellets()
// - attachEventHandlers()
// - moveGhosts()
// - Toda la l√≥gica de movimiento y colisiones

// Las funciones est√°n declaradas aqu√≠ para evitar errores de referencia,
// pero se implementar√°n completamente en las siguientes partes.

// ===============================================================
// üî¨ LABERINTO DE F√çSICA v3 - PARTE 3
// L√ìGICA DEL JUEGO Y MOVIMIENTO
// ===============================================================

console.log("üéÆ Laberinto de F√≠sica v3 - Parte 3 iniciando...");

// ===============================================================
// üéÆ RENDERIZADO DEL JUEGO PRINCIPAL
// ===============================================================

/**
 * Renderiza la interfaz principal del juego
 */
function renderGame() {
    console.log("üé® Renderizando interfaz de juego");
    
    const config = mazeConfigs[gameState.level] || mazeConfigs.easy;
    gameState.mazeWidth = config.width;
    gameState.mazeHeight = config.height;
    
    // Calcular tama√±o √≥ptimo del laberinto
    const availableWidth = Math.min(window.innerWidth - 40, 1000);
    const calculatedCellSize = Math.floor(availableWidth / gameState.mazeWidth);
    const finalCellSize = Math.max(25, Math.min(GAME_CONFIG.CELL_SIZE, calculatedCellSize));
    
    const mazePixelWidth = gameState.mazeWidth * finalCellSize;
    const mazePixelHeight = gameState.mazeHeight * finalCellSize;
    
    // Calcular tama√±os de elementos
    const playerPixelSize = Math.floor(finalCellSize * 0.7);
    const ghostPixelSize = Math.floor(finalCellSize * 0.7);
    const fruitPixelSize = Math.floor(finalCellSize * 0.5);
    const powerPelletPixelSize = Math.floor(finalCellSize * 0.7);

    // Actualizar variables CSS
    document.documentElement.style.setProperty('--cell-size', `${finalCellSize}px`);
    document.documentElement.style.setProperty('--player-size', `${playerPixelSize}px`);
    document.documentElement.style.setProperty('--ghost-size', `${ghostPixelSize}px`);
    document.documentElement.style.setProperty('--fruit-size', `${fruitPixelSize}px`);
    document.documentElement.style.setProperty('--power-pellet-size', `${powerPelletPixelSize}px`);

    // Obtener informaci√≥n del nivel actual
    const levelInfo = GAME_CONFIG.LEVELS[gameState.level];

    appElement.innerHTML = `
        <div class="game-container">
            <!-- Informaci√≥n del nivel -->
            <div class="level-info" style="text-align: center; margin-bottom: 1rem; padding: 0.5rem; background: hsl(var(--secondary) / 0.5); border-radius: 0.5rem;">
                <h3 style="color: hsl(var(--accent)); margin-bottom: 0.25rem;">
                    üìö Nivel ${levelInfo.name}: ${levelInfo.description}
                </h3>
                <p style="font-size: 0.9rem; color: hsl(var(--muted-foreground));">
                    üéØ ${gameState.totalQuestionsInLevel} preguntas ‚Ä¢ üëª ${levelInfo.ghostCount} fantasma(s)
                </p>
            </div>

            <!-- Barra de estad√≠sticas del juego -->
            <div class="game-ui-bar">
                <div class="game-stats">
                    <div class="stat-item">
                        <span>‚ù§Ô∏è</span>
                        <span id="livesValue">${gameState.lives}</span>
                    </div>
                    <div class="stat-item">
                        <span>‚≠ê</span>
                        <span id="scoreValue">${gameState.score}</span>
                    </div>
                    <div class="stat-item">
                        <span>‚ùì</span>
                        <span id="questionProgressValue">0 / ${gameState.totalQuestionsInLevel}</span>
                    </div>
                    <div class="stat-item">
                        <span>üéØ</span>
                        <span id="accuracyValue">0%</span>
                    </div>
                </div>
            </div>

            <!-- Barra de progreso de frutas -->
            <div class="progress-display">
                <span>Progreso:</span>
                <div class="progress-container">
                    <div class="progress-bar" style="width:0%"></div>
                </div>
                <span id="fruitProgressValue">0 / ${gameState.totalFruits}</span>
            </div>

            <!-- Contenedor del laberinto -->
            <div id="mazeContainer" class="game-maze" style="width:${mazePixelWidth}px; height:${mazePixelHeight}px;">
                <div id="staticContainer"></div>
                <div id="dynamicContainer"></div>
            </div>

            <!-- Controles m√≥viles (si es necesario) -->
            ${isMobile ? `
                <div class="mobile-controls">
                    <button class="up" id="upBtn" aria-label="Mover hacia arriba">‚¨ÜÔ∏è</button>
                    <button class="left" id="leftBtn" aria-label="Mover a la izquierda">‚¨ÖÔ∏è</button>
                    <button class="right" id="rightBtn" aria-label="Mover a la derecha">‚û°Ô∏è</button>
                    <button class="down" id="downBtn" aria-label="Mover hacia abajo">‚¨áÔ∏è</button>
                </div>
            ` : ""}

            <!-- Instrucciones -->
            <p class="instructions" style="text-align: center; margin-top: 1rem; color: hsl(var(--muted-foreground)); font-size: 0.9rem;">
                ${isMobile ? "üéÆ Usa los controles t√°ctiles para moverte" : "‚å®Ô∏è Usa las flechas del teclado para moverte"} ‚Ä¢ 
                ‚è∏Ô∏è Usa los botones superiores para pausar/reiniciar
            </p>
        </div>
    `;

    // Agregar event listeners para controles m√≥viles
    if (isMobile) {
        const mobileButtons = [
            { id: "upBtn", direction: "up" },
            { id: "leftBtn", direction: "left" },
            { id: "rightBtn", direction: "right" },
            { id: "downBtn", direction: "down" }
        ];

        mobileButtons.forEach(({ id, direction }) => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener("click", () => handleControlClick(direction));
                btn.addEventListener("touchstart", (e) => {
                    e.preventDefault();
                    handleControlClick(direction);
                });
            }
        });
    }

    // Renderizar el laberinto y elementos
    renderMaze(finalCellSize);
    updateGameUI();
    
    console.log("‚úÖ Interfaz de juego renderizada");
}

// ===============================================================
// üèóÔ∏è INICIALIZACI√ìN DEL LABERINTO
// ===============================================================

/**
 * Inicializa la configuraci√≥n del laberinto seg√∫n el nivel
 */
function initializeMaze() {
    console.log(`üèóÔ∏è Inicializando laberinto para nivel: ${gameState.level}`);
    
    const config = mazeConfigs[gameState.level] || mazeConfigs.easy;
    const levelConfig = GAME_CONFIG.LEVELS[gameState.level];
    
    // Configurar dimensiones
    gameState.mazeWidth = config.width;
    gameState.mazeHeight = config.height;
    
    // Copiar paredes
    gameState.walls = config.walls.map(w => ({...w}));
    
    // Inicializar frutas
    gameState.fruits = config.fruits.map((pos, index) => ({
        id: index,
        position: {...pos},
        collected: false,
        question: null,
        type: 'fruit' // Por defecto, se asignar√° despu√©s
    }));
    
    gameState.fruitCollected = 0;
    gameState.totalFruits = gameState.fruits.length;
    
    // Posici√≥n inicial del jugador
    gameState.playerPosition = { x: 1, y: 1 };
    gameState.playerDirection = "right";
    
    // Resetear contadores
    gameState.questionsAnswered = 0;
    gameState.correctAnswers = 0;
    
    // Inicializar fantasmas seg√∫n el nivel
    const ghostColors = ["#FF0000", "#00FFFF", "#FFB8FF", "#FFB852"];
    const numGhosts = levelConfig.ghostCount;
    gameState.ghosts = [];
    
    // Posiciones iniciales de fantasmas (centro del laberinto)
    const centerX = Math.floor(config.width / 2);
    const centerY = Math.floor(config.height / 2);
    
    for (let i = 0; i < numGhosts; i++) {
        let startX = centerX + (i % 2 === 0 ? -i : i);
        let startY = centerY + (i > 1 ? 1 : -1);
        
        // Verificar que no sea una pared
        if (isWall(startX, startY) || startX < 1 || startX >= config.width - 1) {
            startX = centerX;
            startY = centerY;
        }
        
        gameState.ghosts.push({
            id: i,
            position: { x: startX, y: startY },
            color: ghostColors[i % ghostColors.length],
            el: null,
            vulnerable: false,
            lastDirection: null
        });
    }
    
    // Resetear elementos DOM
    gameState.pacmanEl = null;
    
    console.log(`‚úÖ Laberinto inicializado: ${config.width}x${config.height}, ${numGhosts} fantasmas`);
}

/**
 * Asigna preguntas y power pellets a las frutas
 */
function assignQuestionsAndPellets() {
    console.log("üé≤ Asignando preguntas y power pellets...");
    
    let powerPelletsAssigned = 0;
    let questionsAssigned = 0;
    
    // Crear array de √≠ndices y mezclarlo
    const fruitIndices = Array.from({ length: gameState.fruits.length }, (_, i) => i);
    for (let i = fruitIndices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [fruitIndices[i], fruitIndices[j]] = [fruitIndices[j], fruitIndices[i]];
    }
    
    // Asignar power pellets primero
    fruitIndices.forEach(index => {
        const fruit = gameState.fruits[index];
        
        if (powerPelletsAssigned < GAME_CONFIG.POWER_PELLET_COUNT) {
            fruit.type = 'power';
            fruit.question = null;
            powerPelletsAssigned++;
        } else if (questionsAssigned < gameState.totalQuestionsInLevel && gameState.questionPool.length > 0) {
            const question = getNextQuestion();
            if (question) {
                fruit.question = question;
                fruit.type = 'fruit';
                questionsAssigned++;
            } else {
                fruit.question = null;
                fruit.type = 'fruit';
            }
        } else {
            // Fruta normal sin pregunta
            fruit.question = null;
            fruit.type = 'fruit';
        }
    });
    
    console.log(`‚úÖ Asignaci√≥n completada: ${powerPelletsAssigned} power pellets, ${questionsAssigned} preguntas`);
}

// ===============================================================
// üé® RENDERIZADO DEL LABERINTO
// ===============================================================

/**
 * Renderiza el laberinto completo con todos sus elementos
 */
function renderMaze(cellSize = GAME_CONFIG.CELL_SIZE) {
    console.log("üé® Renderizando laberinto...");
    
    const staticContainer = document.getElementById("staticContainer");
    const dynamicContainer = document.getElementById("dynamicContainer");
    
    if (!staticContainer || !dynamicContainer) {
        console.error("‚ùå Contenedores del laberinto no encontrados");
        return;
    }

    // Limpiar contenedores
    staticContainer.innerHTML = "";
    dynamicContainer.innerHTML = "";
    
    // Resetear referencias
    gameState.pacmanEl = null;
    gameState.ghosts.forEach(g => g.el = null);

    // Renderizar paredes
    gameState.walls.forEach(wall => {
        const wallEl = document.createElement("div");
        wallEl.className = "wall";
        wallEl.style.left = `${wall.x * cellSize}px`;
        wallEl.style.top = `${wall.y * cellSize}px`;
        wallEl.style.width = `${cellSize}px`;
        wallEl.style.height = `${cellSize}px`;
        staticContainer.appendChild(wallEl);
    });

    // Renderizar frutas y power pellets
    renderMazeItems(staticContainer, cellSize);

    // Renderizar Pac-Man
    renderPacMan(dynamicContainer, cellSize);

    // Renderizar fantasmas
    renderGhosts(dynamicContainer, cellSize);
    
    console.log("‚úÖ Laberinto renderizado completamente");
}

/**
 * Renderiza frutas y power pellets en el laberinto
 */
function renderMazeItems(container, cellSize) {
    const fruitEmojis = ["üçé", "üçå", "üçá", "üçí", "üçâ", "üçì", "üçç", "ü•ù", "üçë", "üçä"];
    
    gameState.fruits.forEach(fruit => {
        if (!fruit.collected) {
            const itemEl = document.createElement("div");
            const itemSize = fruit.type === 'power' ? 
                parseInt(document.documentElement.style.getPropertyValue('--power-pellet-size') || GAME_CONFIG.POWER_PELLET_SIZE) :
                parseInt(document.documentElement.style.getPropertyValue('--fruit-size') || GAME_CONFIG.FRUIT_SIZE);
            
            itemEl.className = fruit.type === 'power' ? 'power-pellet' : 'fruit';
            itemEl.textContent = fruit.type === 'power' ? 'üíä' : fruitEmojis[fruit.id % fruitEmojis.length];
            itemEl.style.fontSize = `${itemSize * 0.8}px`;
            itemEl.style.width = `${itemSize}px`;
            itemEl.style.height = `${itemSize}px`;
            itemEl.style.left = `${fruit.position.x * cellSize + (cellSize - itemSize) / 2}px`;
            itemEl.style.top = `${fruit.position.y * cellSize + (cellSize - itemSize) / 2}px`;
            
            // Agregar informaci√≥n de tooltip para debug
            if (fruit.question) {
                itemEl.title = `Pregunta: ${fruit.question.tema}`;
            } else if (fruit.type === 'power') {
                itemEl.title = "Power Pellet: +1 vida";
            }
            
            container.appendChild(itemEl);
        }
    });
}

/**
 * Renderiza el jugador Pac-Man
 */
function renderPacMan(container, cellSize) {
    const playerPixelSize = parseInt(document.documentElement.style.getPropertyValue('--player-size') || GAME_CONFIG.PLAYER_SIZE);
    
    gameState.pacmanEl = document.createElement("div");
    gameState.pacmanEl.className = "pacman-player";
    gameState.pacmanEl.setAttribute('data-direction', gameState.playerDirection);
    
    // Crear la boca del Pac-Man
    const mouthEl = document.createElement("div");
    mouthEl.className = "pacman-mouth";
    gameState.pacmanEl.appendChild(mouthEl);
    
    // Posicionar Pac-Man
    gameState.pacmanEl.style.left = `${gameState.playerPosition.x * cellSize + (cellSize - playerPixelSize) / 2}px`;
    gameState.pacmanEl.style.top = `${gameState.playerPosition.y * cellSize + (cellSize - playerPixelSize) / 2}px`;
    
    container.appendChild(gameState.pacmanEl);
}

/**
 * Renderiza los fantasmas
 */
function renderGhosts(container, cellSize) {
    const ghostPixelSize = parseInt(document.documentElement.style.getPropertyValue('--ghost-size') || GAME_CONFIG.GHOST_SIZE);
    
    gameState.ghosts.forEach(ghost => {
        ghost.el = document.createElement("div");
        ghost.el.className = "ghost";
        ghost.el.style.backgroundColor = ghost.vulnerable ? "#0066FF" : ghost.color;
        ghost.el.setAttribute('data-look', 'right');
        
        // Crear ojos del fantasma
        const eyesContainer = document.createElement("div");
        eyesContainer.className = 'ghost-eyes';
        
        const eyeLeft = document.createElement("div");
        eyeLeft.className = "ghost-eye";
        const pupilLeft = document.createElement("div");
        pupilLeft.className = "ghost-pupil";
        eyeLeft.appendChild(pupilLeft);
        
        const eyeRight = document.createElement("div");
        eyeRight.className = "ghost-eye";
        const pupilRight = document.createElement("div");
        pupilRight.className = "ghost-pupil";
        eyeRight.appendChild(pupilRight);
        
        eyesContainer.appendChild(eyeLeft);
        eyesContainer.appendChild(eyeRight);
        ghost.el.appendChild(eyesContainer);
        
        // Posicionar fantasma
        ghost.el.style.left = `${ghost.position.x * cellSize + (cellSize - ghostPixelSize) / 2}px`;
        ghost.el.style.top = `${ghost.position.y * cellSize + (cellSize - ghostPixelSize) / 2}px`;
        
        container.appendChild(ghost.el);
    });
}

// ===============================================================
// üéÆ SISTEMA DE CONTROLES
// ===============================================================

/**
 * Adjunta los manejadores de eventos para controles
 */
function attachEventHandlers() {
    console.log("üéÆ Configurando controles...");
    
    // Remover listeners previos para evitar duplicados
    document.removeEventListener("keydown", handleKeyDown);
    
    // Agregar nuevo listener
    document.addEventListener("keydown", handleKeyDown);
    
    console.log("‚úÖ Controles configurados");
}

/**
 * Maneja las teclas presionadas
 */
function handleKeyDown(e) {
    // Verificar si el juego puede recibir input
    if (!gameState.gameStarted || 
        gameState.paused || 
        gameState.gameCompleted ||
        (questionDialog && questionDialog.style.display !== 'none') || 
        (completionDialog && completionDialog.style.display !== 'none') ||
        (helpDialog && helpDialog.style.display !== 'none')) {
        return;
    }

    // Manejar teclas de flecha
    if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
        e.preventDefault(); // Prevenir scroll de p√°gina
        
        switch(e.key) {
            case "ArrowUp": movePlayer("up"); break;
            case "ArrowDown": movePlayer("down"); break;
            case "ArrowLeft": movePlayer("left"); break;
            case "ArrowRight": movePlayer("right"); break;
        }
    }
}

/**
 * Maneja los clics en controles m√≥viles
 */
function handleControlClick(direction) {
    // Verificar si el juego puede recibir input
    if (!gameState.gameStarted || 
        gameState.paused || 
        gameState.gameCompleted ||
        (questionDialog && questionDialog.style.display !== 'none') || 
        (completionDialog && completionDialog.style.display !== 'none') ||
        (helpDialog && helpDialog.style.display !== 'none')) {
        return;
    }
    
    movePlayer(direction);
}

// ===============================================================
// üèÉ‚Äç‚ôÇÔ∏è L√ìGICA DE MOVIMIENTO DEL JUGADOR
// ===============================================================

/**
 * Mueve el jugador en la direcci√≥n especificada
 */
function movePlayer(direction) {
    let newPos = { ...gameState.playerPosition };
    
    // Calcular nueva posici√≥n
    switch(direction) {
        case "up": newPos.y--; break;
        case "down": newPos.y++; break;
        case "left": newPos.x--; break;
        case "right": newPos.x++; break;
    }

    // Verificar l√≠mites y paredes
    if (newPos.x >= 0 && newPos.x < gameState.mazeWidth && 
        newPos.y >= 0 && newPos.y < gameState.mazeHeight && 
        !isWall(newPos.x, newPos.y)) {
        
        // Mover jugador
        gameState.playerPosition = newPos;
        gameState.playerDirection = direction;

        // Verificar colisi√≥n con items
        checkItemCollection();
        
        // Verificar colisi√≥n con fantasmas
        checkGhostCollision();
        
        // Actualizar elementos visuales
        updateDynamicElements();
        
        // Verificar condici√≥n de victoria
        checkWinCondition();
        
    } else {
        // Solo actualizar direcci√≥n visual
        gameState.playerDirection = direction;
        updateDynamicElements();
    }
}

/**
 * Verifica si hay una pared en la posici√≥n dada
 */
function isWall(x, y) {
    return gameState.walls.some(w => w.x === x && w.y === y);
}

/**
 * Verifica la recolecci√≥n de items (frutas/power pellets)
 */
function checkItemCollection() {
    const playerPos = gameState.playerPosition;
    const itemIndex = gameState.fruits.findIndex(f => 
        !f.collected && 
        f.position.x === playerPos.x && 
        f.position.y === playerPos.y
    );
    
    if (itemIndex !== -1) {
        const collectedItem = gameState.fruits[itemIndex];
        collectedItem.collected = true;
        gameState.fruitCollected++;
        
        console.log(`üçé Item recolectado: ${collectedItem.type} en (${playerPos.x}, ${playerPos.y})`);
        
        // Re-renderizar items est√°ticos
        const staticContainer = document.getElementById("staticContainer");
        if (staticContainer) {
            const cellSize = parseInt(document.documentElement.style.getPropertyValue('--cell-size') || GAME_CONFIG.CELL_SIZE);
            renderMazeItems(staticContainer, cellSize);
        }

        if (collectedItem.type === 'power') {
            handlePowerPelletCollection();
        } else if (collectedItem.question) {
            handleQuestionFruit(collectedItem.question);
        } else {
            // Fruta normal sin pregunta
            gameState.score += GAME_CONFIG.POINTS.FRUIT_BASIC;
            showToast("¬°Fruta!", `+${GAME_CONFIG.POINTS.FRUIT_BASIC} puntos`, "default");
            updateGameUI();
        }
    }
}

/**
 * Maneja la recolecci√≥n de power pellet
 */
function handlePowerPelletCollection() {
    console.log("üíä Power pellet recolectado");
    
    // Dar vida extra si no est√° al m√°ximo
    if (gameState.lives < GAME_CONFIG.MAX_LIVES) {
        gameState.lives++;
        showToast("¬°Vida Extra!", `‚ù§Ô∏è Vidas: ${gameState.lives}`, "success");
    } else {
        showToast("¬°Power Pellet!", "Ya tienes el m√°ximo de vidas", "default");
    }
    
    // Hacer fantasmas vulnerables
    makeGhostsVulnerable();
    
    updateGameUI();
}

/**
 * Hace que los fantasmas sean vulnerables temporalmente
 */
function makeGhostsVulnerable() {
    gameState.ghostsVulnerable = true;
    gameState.powerPelletActive = true;
    
    // Cambiar apariencia de fantasmas
    gameState.ghosts.forEach(ghost => {
        ghost.vulnerable = true;
        if (ghost.el) {
            ghost.el.style.backgroundColor = "#0066FF";
            ghost.el.classList.add("vulnerable");
        }
    });
    
    // Limpiar timer anterior si existe
    if (gameState.vulnerableGhostsTimer) {
        clearTimeout(gameState.vulnerableGhostsTimer);
    }
    
    // Timer para volver fantasmas a normal
    gameState.vulnerableGhostsTimer = setTimeout(() => {
        gameState.ghostsVulnerable = false;
        gameState.powerPelletActive = false;
        
        gameState.ghosts.forEach(ghost => {
            ghost.vulnerable = false;
            if (ghost.el) {
                ghost.el.style.backgroundColor = ghost.color;
                ghost.el.classList.remove("vulnerable", "vulnerable-ending");
            }
        });
        
        showToast("‚ö†Ô∏è Advertencia", "Los fantasmas ya no son vulnerables", "destructive");
    }, GAME_CONFIG.VULNERABLE_TIME);
    
    // Timer de advertencia antes de que termine el efecto
    setTimeout(() => {
        if (gameState.ghostsVulnerable) {
            gameState.ghosts.forEach(ghost => {
                if (ghost.el) {
                    ghost.el.classList.add("vulnerable-ending");
                }
            });
            showToast("‚è∞ ¬°Cuidado!", "El efecto del power pellet est√° terminando", "destructive");
        }
    }, GAME_CONFIG.VULNERABLE_TIME - 2000);
    
    showToast("üíä ¬°Power Activo!", "¬°Ahora puedes comer fantasmas!", "success");
}

/**
 * Maneja frutas con preguntas
 */
function handleQuestionFruit(question) {
    console.log(`‚ùì Fruta con pregunta recolectada: ${question.tema}`);
    
    gameState.currentQuestion = question;
    gameState.questionStartTime = Date.now();
    showQuestionDialog();
}

// ===============================================================
// üìù LOGGING Y PREPARACI√ìN PARA SIGUIENTE PARTE
// ===============================================================

console.log("üî¨ Laberinto de F√≠sica v3 - Parte 3 cargada exitosamente");
console.log("‚úÖ Funciones implementadas:");
console.log("   - Renderizado del juego");
console.log("   - Inicializaci√≥n del laberinto");
console.log("   - Sistema de controles");
console.log("   - Movimiento del jugador");
console.log("   - Recolecci√≥n de items");
console.log("   - Power pellets y vulnerabilidad");
console.log("‚è≥ Esperando Parte 4: Sistema de Preguntas y Fantasmas...");

// ===============================================================
// üîó FUNCIONES QUE SE IMPLEMENTAR√ÅN EN LA PARTE 4
// ===============================================================

// Funciones pendientes para Parte 4:
// - showQuestionDialog()
// - handleQuestionResponse()
// - moveGhosts()
// - checkGhostCollision() 
// - updateDynamicElements()
// - updateGameUI()
// - checkWinCondition()
// - showToast()
// - Sistema completo de preguntas con UI mejorada


// ===============================================================
// üî¨ LABERINTO DE F√çSICA v3 - PARTE 4
// SISTEMA DE PREGUNTAS Y IA DE FANTASMAS
// ===============================================================

console.log("‚ùì Laberinto de F√≠sica v3 - Parte 4 iniciando...");

// ===============================================================
// üí¨ SISTEMA DE NOTIFICACIONES TOAST
// ===============================================================

/**
 * Muestra una notificaci√≥n toast
 * @param {string} title - T√≠tulo de la notificaci√≥n
 * @param {string} message - Mensaje de la notificaci√≥n
 * @param {string} type - Tipo: "default", "success", "destructive"
 */
function showToast(title, message, type = "default") {
    const toast = document.createElement("div");
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-title">${title}</div>
        <div class="toast-description">${message}</div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Animar entrada
    setTimeout(() => {
        toast.style.opacity = "1";
        toast.style.transform = "translateX(0)";
    }, 10);
    
    // Programar eliminaci√≥n
    setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateX(100%)";
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 300);
    }, 3000);
}

// ===============================================================
// ‚ùì SISTEMA DE PREGUNTAS MEJORADO
// ===============================================================

/**
 * Muestra el di√°logo de pregunta con UI mejorada
 */
function showQuestionDialog() {
    if (!gameState.currentQuestion) {
        console.error("‚ùå No hay pregunta actual para mostrar");
        return;
    }

    console.log(`‚ùì Mostrando pregunta: ${gameState.currentQuestion.tema}`);
    
    // Pausar el juego
    gameState.paused = true;
    if (gameState.ghostMovementInterval) {
        clearInterval(gameState.ghostMovementInterval);
        gameState.ghostMovementInterval = null;
    }
    
    // Actualizar botones globales
    globalPauseBtn.textContent = "‚è∏Ô∏è Pausado";
    globalPauseBtn.disabled = true;

    // Crear HTML del di√°logo mejorado
    const questionHTML = `
        <div class="dialog-content" style="max-width: 600px;">
            <div class="dialog-header">
                <h2 class="dialog-title" style="color: var(--question-title-color); font-size: 1.8rem;">
                    üß† Pregunta de ${gameState.currentQuestion.tema}
                </h2>
                <p class="dialog-description">
                    Pregunta ${gameState.questionsAnswered + 1} de ${gameState.totalQuestionsInLevel} ‚Ä¢ 
                    Nivel: ${GAME_CONFIG.LEVELS[gameState.level].name}
                </p>
            </div>
            <div class="dialog-body">
                <div id="questionText" style="font-size: 1.2rem; font-weight: 500; margin-bottom: 1.5rem; text-align: center; line-height: 1.5; padding: 1rem; background: hsl(var(--secondary) / 0.3); border-radius: 0.5rem; border-left: 4px solid hsl(var(--accent));">
                    ${gameState.currentQuestion.question}
                </div>
                <div class="options-container" id="optionsContainer">
                    <!-- Las opciones se generar√°n din√°micamente -->
                </div>
                <div id="questionTimer" style="text-align: center; margin-top: 1rem; font-size: 0.9rem; color: hsl(var(--muted-foreground));">
                    ‚è±Ô∏è Tiempo transcurrido: <span id="timerValue">0</span>s
                </div>
            </div>
        </div>
    `;

    questionDialog.innerHTML = questionHTML;
    
    // Generar opciones mezcladas
    const optionsContainer = document.getElementById("optionsContainer");
    const shuffledOptions = [...gameState.currentQuestion.opciones].sort(() => Math.random() - 0.5);
    
    shuffledOptions.forEach((opcion, index) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.innerHTML = `
            <span style="font-weight: bold; color: hsl(var(--accent)); margin-right: 0.5rem;">
                ${String.fromCharCode(65 + index)})
            </span>
            ${opcion}
        `;
        btn.addEventListener("click", () => handleQuestionResponse(opcion));
        optionsContainer.appendChild(btn);
    });
    
    // Mostrar di√°logo
    questionDialog.style.display = 'flex';
    
    // Iniciar timer visual
    startQuestionTimer();
}

/**
 * Inicia el timer visual de la pregunta
 */
function startQuestionTimer() {
    const timerValue = document.getElementById("timerValue");
    if (!timerValue) return;
    
    const startTime = Date.now();
    
    const updateTimer = () => {
        if (questionDialog.style.display === 'none') return;
        
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timerValue.textContent = elapsed;
        
        // Cambiar color seg√∫n tiempo transcurrido
        if (elapsed > 20) {
            timerValue.style.color = "hsl(var(--destructive))";
        } else if (elapsed > 10) {
            timerValue.style.color = "orange";
        }
        
        setTimeout(updateTimer, 1000);
    };
    
    updateTimer();
}

/**
 * Maneja la respuesta del usuario a una pregunta
 * @param {string} selectedOption - Opci√≥n seleccionada por el usuario
 */
function handleQuestionResponse(selectedOption) {
    if (!gameState.currentQuestion) return;
    
    console.log(`‚úÖ Respuesta seleccionada: ${selectedOption}`);
    
    const correctAnswer = gameState.currentQuestion.respuestaCorrecta.trim();
    const userAnswer = selectedOption.trim();
    const isCorrect = userAnswer === correctAnswer;
    
    // Calcular tiempo de respuesta
    const responseTime = Date.now() - gameState.questionStartTime;
    const isQuickResponse = responseTime < 10000; // Menos de 10 segundos
    
    // Actualizar estad√≠sticas
    gameState.questionsAnswered++;
    if (isCorrect) {
        gameState.correctAnswers++;
    }
    
    // Calcular puntos
    let points = 0;
    if (isCorrect) {
        points = GAME_CONFIG.POINTS[`QUESTION_${gameState.level.toUpperCase()}`];
        
        // Bonus por respuesta r√°pida
        if (isQuickResponse) {
            points += GAME_CONFIG.POINTS.SPEED_BONUS;
        }
        
        gameState.score += points;
        
        // Mostrar feedback positivo
        const bonusText = isQuickResponse ? ` (+${GAME_CONFIG.POINTS.SPEED_BONUS} bonus r√°pido)` : "";
        showToast(
            "üéâ ¬°Correcto!", 
            `+${points} puntos${bonusText}${gameState.currentQuestion.explicacion ? '\nüí° ' + gameState.currentQuestion.explicacion : ''}`, 
            "success"
        );
    } else {
        // Respuesta incorrecta - perder vida
        gameState.lives--;
        
        showToast(
            "‚ùå Incorrecto", 
            `Respuesta correcta: ${correctAnswer}\n${gameState.currentQuestion.explicacion ? 'üí° ' + gameState.currentQuestion.explicacion : ''}\nüíî Vidas restantes: ${gameState.lives}`, 
            "destructive"
        );
        
        // Verificar game over
        if (gameState.lives <= 0) {
            questionDialog.style.display = 'none';
            endGame(false);
            return;
        }
    }
    
    // Limpiar pregunta actual
    gameState.currentQuestion = null;
    questionDialog.style.display = 'none';
    
    // Reanudar juego despu√©s de un breve delay
    setTimeout(() => {
        gameState.paused = false;
        globalPauseBtn.disabled = false;
        globalPauseBtn.textContent = "‚è∏Ô∏è Pausar";
        
        // Reiniciar movimiento de fantasmas si el juego no ha terminado
        if (!gameState.gameCompleted && !gameState.ghostMovementInterval) {
            const ghostSpeed = GAME_CONFIG.LEVELS[gameState.level].ghostSpeed;
            gameState.ghostMovementInterval = setInterval(moveGhosts, ghostSpeed);
        }
        
        updateGameUI();
    }, 1500); // Delay para que el usuario lea el feedback
}

// ===============================================================
// üëª IA DE FANTASMAS MEJORADA
// ===============================================================

/**
 * Mueve todos los fantasmas seg√∫n su IA
 */
function moveGhosts() {
    // Verificar estado del juego
    if (!gameState.gameStarted || 
        gameState.gameCompleted || 
        gameState.paused || 
        (questionDialog && questionDialog.style.display !== 'none')) {
        return;
    }
    
    if (!gameState.ghosts.length) return;
    
    gameState.ghosts.forEach(ghost => {
        moveGhost(ghost);
    });
    
    // Verificar colisiones despu√©s de mover todos los fantasmas
    checkGhostCollision();
    updateDynamicElements();
}

/**
 * Mueve un fantasma individual con IA mejorada
 * @param {Object} ghost - Fantasma a mover
 */
function moveGhost(ghost) {
    const directions = [
        { dx: 1, dy: 0, name: "right" },
        { dx: -1, dy: 0, name: "left" },
        { dx: 0, dy: 1, name: "down" },
        { dx: 0, dy: -1, name: "up" }
    ];
    
    let validMoves = [];
    let bestMove = null;
    let minDistance = Infinity;
    
    // Calcular vector hacia el jugador
    const dxPlayer = gameState.playerPosition.x - ghost.position.x;
    const dyPlayer = gameState.playerPosition.y - ghost.position.y;
    const playerDistance = Math.sqrt(dxPlayer * dxPlayer + dyPlayer * dyPlayer);
    
    // Evaluar cada direcci√≥n posible
    directions.forEach(dir => {
        const newX = ghost.position.x + dir.dx;
        const newY = ghost.position.y + dir.dy;
        
        // Verificar si el movimiento es v√°lido
        if (newX >= 0 && newX < gameState.mazeWidth && 
            newY >= 0 && newY < gameState.mazeHeight && 
            !isWall(newX, newY)) {
            
            validMoves.push(dir);
            
            // Calcular distancia al jugador desde esta nueva posici√≥n
            const distanceToPlayer = Math.sqrt(
                Math.pow(gameState.playerPosition.x - newX, 2) + 
                Math.pow(gameState.playerPosition.y - newY, 2)
            );
            
            // Encontrar el mejor movimiento seg√∫n el estado del fantasma
            if (ghost.vulnerable) {
                // Si es vulnerable, huir del jugador (maximizar distancia)
                if (distanceToPlayer > minDistance) {
                    minDistance = distanceToPlayer;
                    bestMove = dir;
                }
            } else {
                // Si no es vulnerable, perseguir al jugador (minimizar distancia)
                if (distanceToPlayer < minDistance) {
                    minDistance = distanceToPlayer;
                    bestMove = dir;
                }
            }
        }
    });
    
    if (validMoves.length === 0) return; // No hay movimientos v√°lidos
    
    // Determinar movimiento final basado en dificultad y estado
    let chosenMove = null;
    
    if (ghost.vulnerable) {
        // Comportamiento de huida cuando es vulnerable
        if (bestMove && Math.random() < 0.8) {
            chosenMove = bestMove; // 80% probabilidad de huir inteligentemente
        } else {
            chosenMove = validMoves[Math.floor(Math.random() * validMoves.length)];
        }
    } else {
        // Comportamiento de persecuci√≥n normal
        const chasePercentage = getLevelChasePercentage();
        
        if (bestMove && Math.random() < chasePercentage) {
            chosenMove = bestMove; // Perseguir inteligentemente
        } else {
            // Evitar reversa inmediata para movimiento m√°s natural
            const nonReverseMoves = validMoves.filter(move => {
                if (!ghost.lastDirection) return true;
                return !(move.dx === -ghost.lastDirection.dx && move.dy === -ghost.lastDirection.dy);
            });
            
            const movesToChoose = nonReverseMoves.length > 0 ? nonReverseMoves : validMoves;
            chosenMove = movesToChoose[Math.floor(Math.random() * movesToChoose.length)];
        }
    }
    
    // Ejecutar movimiento
    if (chosenMove) {
        ghost.position.x += chosenMove.dx;
        ghost.position.y += chosenMove.dy;
        ghost.lastDirection = chosenMove;
        
        // Actualizar direcci√≥n visual de las pupilas
        updateGhostLook(ghost, dxPlayer, dyPlayer);
    }
}

/**
 * Obtiene el porcentaje de persecuci√≥n seg√∫n el nivel
 * @returns {number} Porcentaje de 0 a 1
 */
function getLevelChasePercentage() {
    switch(gameState.level) {
        case 'easy': return 0.4;     // 40% persecuci√≥n inteligente
        case 'medium': return 0.6;   // 60% persecuci√≥n inteligente
        case 'hard': return 0.75;    // 75% persecuci√≥n inteligente
        case 'expert': return 0.85;  // 85% persecuci√≥n inteligente
        default: return 0.5;
    }
}

/**
 * Actualiza la direcci√≥n visual de un fantasma
 * @param {Object} ghost - Fantasma a actualizar
 * @param {number} dxPlayer - Diferencia X hacia el jugador
 * @param {number} dyPlayer - Diferencia Y hacia el jugador
 */
function updateGhostLook(ghost, dxPlayer, dyPlayer) {
    if (!ghost.el) return;
    
    let lookDir = "right";
    
    // Determinar direcci√≥n visual basada en posici√≥n relativa del jugador
    if (Math.abs(dxPlayer) > Math.abs(dyPlayer)) {
        lookDir = dxPlayer < 0 ? "left" : "right";
    } else {
        lookDir = dyPlayer < 0 ? "up" : "down";
    }
    
    ghost.el.setAttribute('data-look', lookDir);
}

// ===============================================================
// üí• SISTEMA DE COLISIONES
// ===============================================================

/**
 * Verifica colisiones entre el jugador y los fantasmas
 */
function checkGhostCollision() {
    if (gameState.paused || gameState.gameCompleted) return;
    
    let collisionOccurred = false;
    let ghostEaten = null;
    
    gameState.ghosts.forEach(ghost => {
        if (ghost.position.x === gameState.playerPosition.x && 
            ghost.position.y === gameState.playerPosition.y) {
            
            if (ghost.vulnerable && gameState.ghostsVulnerable) {
                // Comer fantasma vulnerable
                ghostEaten = ghost;
            } else {
                // Colisi√≥n con fantasma no vulnerable
                collisionOccurred = true;
            }
        }
    });
    
    if (ghostEaten) {
        handleGhostEaten(ghostEaten);
    } else if (collisionOccurred) {
        handlePlayerCaught();
    }
}

/**
 * Maneja cuando el jugador come un fantasma vulnerable
 * @param {Object} ghost - Fantasma comido
 */
function handleGhostEaten(ghost) {
    console.log(`üëª Fantasma ${ghost.id} comido`);
    
    // Agregar puntos
    gameState.score += GAME_CONFIG.POINTS.GHOST_EATEN;
    
    // Mover fantasma al centro del laberinto
    const centerX = Math.floor(gameState.mazeWidth / 2);
    const centerY = Math.floor(gameState.mazeHeight / 2);
    ghost.position = { x: centerX, y: centerY };
    
    // Quitar vulnerabilidad del fantasma espec√≠fico
    ghost.vulnerable = false;
    if (ghost.el) {
        ghost.el.style.backgroundColor = ghost.color;
        ghost.el.classList.remove("vulnerable", "vulnerable-ending");
    }
    
    showToast(
        "üëª ¬°Fantasma Comido!", 
        `+${GAME_CONFIG.POINTS.GHOST_EATEN} puntos`, 
        "success"
    );
    
    updateGameUI();
}

/**
 * Maneja cuando un fantasma atrapa al jugador
 */
function handlePlayerCaught() {
    console.log("üíî Jugador atrapado por fantasma");
    
    gameState.lives--;
    
    showToast(
        "üëª ¬°Atrapado!", 
        `Un fantasma te ha atrapado. Vidas restantes: ${gameState.lives}`, 
        "destructive"
    );
    
    if (gameState.lives <= 0) {
        endGame(false);
    } else {
        // Reiniciar posici√≥n del jugador
        gameState.playerPosition = { x: 1, y: 1 };
        updateDynamicElements();
    }
    
    updateGameUI();
}

// ===============================================================
// üîÑ ACTUALIZACI√ìN DE ELEMENTOS DIN√ÅMICOS
// ===============================================================

/**
 * Actualiza las posiciones visuales de elementos din√°micos
 */
function updateDynamicElements() {
    const cellSize = parseInt(document.documentElement.style.getPropertyValue('--cell-size') || GAME_CONFIG.CELL_SIZE);
    const playerPixelSize = parseInt(document.documentElement.style.getPropertyValue('--player-size') || GAME_CONFIG.PLAYER_SIZE);
    const ghostPixelSize = parseInt(document.documentElement.style.getPropertyValue('--ghost-size') || GAME_CONFIG.GHOST_SIZE);
    
    // Actualizar posici√≥n del Pac-Man
    if (gameState.pacmanEl) {
        gameState.pacmanEl.style.left = `${gameState.playerPosition.x * cellSize + (cellSize - playerPixelSize) / 2}px`;
        gameState.pacmanEl.style.top = `${gameState.playerPosition.y * cellSize + (cellSize - playerPixelSize) / 2}px`;
        gameState.pacmanEl.setAttribute('data-direction', gameState.playerDirection);
    }
    
    // Actualizar posiciones de fantasmas
    gameState.ghosts.forEach(ghost => {
        if (ghost.el) {
            ghost.el.style.left = `${ghost.position.x * cellSize + (cellSize - ghostPixelSize) / 2}px`;
            ghost.el.style.top = `${ghost.position.y * cellSize + (cellSize - ghostPixelSize) / 2}px`;
            
            // Actualizar color seg√∫n vulnerabilidad
            if (ghost.vulnerable) {
                ghost.el.style.backgroundColor = "#0066FF";
            } else {
                ghost.el.style.backgroundColor = ghost.color;
            }
        }
    });
    
    // Actualizar UI
    updateGameUI();
}

/**
 * Actualiza la interfaz de usuario del juego
 */
function updateGameUI() {
    // Actualizar vidas
    const livesEl = document.getElementById("livesValue");
    if (livesEl) livesEl.textContent = gameState.lives;
    
    // Actualizar puntuaci√≥n
    const scoreEl = document.getElementById("scoreValue");
    if (scoreEl) scoreEl.textContent = gameState.score;
    
    // Actualizar progreso de preguntas
    updateQuestionProgressDisplay();
    
    // Actualizar precisi√≥n
    updateAccuracyDisplay();
    
    // Actualizar barra de progreso de frutas
    const progressBar = document.querySelector(".progress-bar");
    if (progressBar) {
        const progressPercentage = gameState.totalFruits > 0 ? 
            (gameState.fruitCollected / gameState.totalFruits) * 100 : 0;
        progressBar.style.width = `${progressPercentage}%`;
    }
    
    const fruitProgressEl = document.getElementById("fruitProgressValue");
    if (fruitProgressEl) {
        fruitProgressEl.textContent = `${gameState.fruitCollected} / ${gameState.totalFruits}`;
    }
}

/**
 * Actualiza el display de progreso de preguntas
 */
function updateQuestionProgressDisplay() {
    const displayEl = document.getElementById("questionProgressValue");
    if (displayEl) {
        const answeredToShow = Math.min(gameState.questionsAnswered, gameState.totalQuestionsInLevel);
        displayEl.textContent = `${answeredToShow} / ${gameState.totalQuestionsInLevel}`;
    }
}

/**
 * Actualiza el display de precisi√≥n
 */
function updateAccuracyDisplay() {
    const accuracyEl = document.getElementById("accuracyValue");
    if (accuracyEl) {
        const accuracy = gameState.questionsAnswered > 0 ? 
            Math.round((gameState.correctAnswers / gameState.questionsAnswered) * 100) : 0;
        accuracyEl.textContent = `${accuracy}%`;
        
        // Cambiar color seg√∫n precisi√≥n
        if (accuracy >= 80) {
            accuracyEl.style.color = "hsl(var(--accent))"; // Verde/amarillo
        } else if (accuracy >= 60) {
            accuracyEl.style.color = "orange";
        } else {
            accuracyEl.style.color = "hsl(var(--destructive))";
        }
    }
}

// ===============================================================
// üèÜ CONDICIONES DE VICTORIA Y FINALIZACI√ìN
// ===============================================================

/**
 * Verifica si se ha cumplido la condici√≥n de victoria
 */
function checkWinCondition() {
    if (!gameState.gameCompleted && 
        gameState.fruitCollected === gameState.totalFruits && 
        gameState.totalFruits > 0) {
        
        console.log("üèÜ ¬°Condici√≥n de victoria cumplida!");
        endGame(true);
    }
}

/**
 * Finaliza el juego
 * @param {boolean} victory - Si el jugador gan√≥
 */
function endGame(victory) {
    if (gameState.gameCompleted) return; // Evitar m√∫ltiples llamadas
    
    console.log(`üéÆ Finalizando juego - Victoria: ${victory}`);
    
    // Marcar juego como completado
    gameState.gameCompleted = true;
    gameState.paused = true;
    
    // Limpiar intervalos
    if (gameState.ghostMovementInterval) {
        clearInterval(gameState.ghostMovementInterval);
        gameState.ghostMovementInterval = null;
    }
    
    if (gameState.vulnerableGhostsTimer) {
        clearTimeout(gameState.vulnerableGhostsTimer);
        gameState.vulnerableGhostsTimer = null;
    }
    
    // Ocultar di√°logos de pregunta si est√°n abiertos
    questionDialog.style.display = 'none';
    
    // Calcular calificaci√≥n final
    gameState.finalGrade = calculateFinalGrade();
    
    // Deshabilitar bot√≥n de pausa
    globalPauseBtn.disabled = true;
    globalPauseBtn.textContent = "üèÅ Finalizado";
    
    // Mostrar di√°logo de finalizaci√≥n despu√©s de un breve delay
    setTimeout(() => {
        showCompletionDialog(victory);
    }, 500);
}

// ===============================================================
// üìù LOGGING Y PREPARACI√ìN PARA SIGUIENTE PARTE
// ===============================================================

console.log("üî¨ Laberinto de F√≠sica v3 - Parte 4 cargada exitosamente");
console.log("‚úÖ Funciones implementadas:");
console.log("   - Sistema completo de preguntas con timer");
console.log("   - IA mejorada de fantasmas con comportamientos");
console.log("   - Sistema de colisiones y vulnerabilidad");
console.log("   - Actualizaci√≥n din√°mica de UI");
console.log("   - Condiciones de victoria y derrota");
console.log("   - Sistema de notificaciones toast");
console.log("‚è≥ Esperando Parte 5: Finalizaci√≥n y Controles Globales...");

// ===============================================================
// üîó FUNCIONES QUE SE IMPLEMENTAR√ÅN EN LA PARTE 5
// ===============================================================

// Funciones pendientes para Parte 5:
// - showCompletionDialog()
// - Sistema de pausa/reinicio global
// - Configuraci√≥n de event listeners globales
// - Inicializaci√≥n completa de la aplicaci√≥n
// - Manejo de redimensionamiento de ventana

// ===============================================================
// üî¨ LABERINTO DE F√çSICA v3 - PARTE 5 FINAL
// DI√ÅLOGOS DE FINALIZACI√ìN Y CONTROLES GLOBALES
// ===============================================================

console.log("üèÅ Laberinto de F√≠sica v3 - Parte 5 Final iniciando...");

// ===============================================================
// üèÜ DI√ÅLOGO DE FINALIZACI√ìN MEJORADO
// ===============================================================

/**
 * Muestra el di√°logo de finalizaci√≥n del juego
 * @param {boolean} victory - Si el jugador gan√≥
 */
function showCompletionDialog(victory) {
    console.log(`üèÜ Mostrando di√°logo de finalizaci√≥n - Victoria: ${victory}`);
    
    const finalMessage = getFinalMessage(gameState.finalGrade);
    const levelInfo = GAME_CONFIG.LEVELS[gameState.level];
    
    // Calcular estad√≠sticas adicionales
    const accuracy = gameState.questionsAnswered > 0 ? 
        ((gameState.correctAnswers / gameState.questionsAnswered) * 100).toFixed(1) : 0;
    const completionPercentage = ((gameState.fruitCollected / gameState.totalFruits) * 100).toFixed(1);
    
    // Determinar t√≠tulo y descripci√≥n
    const title = victory ? "üéâ ¬°Nivel Completado!" : "üíî Juego Terminado";
    const description = victory ? 
        "¬°Felicitaciones! Has demostrado un excelente conocimiento de f√≠sica." :
        "No te desanimes. La f√≠sica requiere pr√°ctica y perseverancia.";
    
    // Crear HTML del di√°logo
    const completionHTML = `
        <div class="dialog-content" style="max-width: 650px;">
            <div class="dialog-header">
                <h2 class="dialog-title" style="font-size: 2rem; margin-bottom: 1rem;">
                    ${title}
                </h2>
                <p class="dialog-description" style="font-size: 1.1rem;">
                    ${description}
                </p>
            </div>
            <div class="dialog-body" style="text-align: left;">
                <!-- Informaci√≥n del nivel -->
                <div style="background: hsl(var(--secondary) / 0.5); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; text-align: center;">
                    <h3 style="color: hsl(var(--accent)); margin-bottom: 0.5rem;">
                        üìö Nivel: ${levelInfo.name}
                    </h3>
                    <p style="font-size: 0.9rem; color: hsl(var(--muted-foreground));">
                        ${levelInfo.description}
                    </p>
                </div>

                <!-- Calificaci√≥n principal -->
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 3rem; font-weight: bold; color: ${getGradeColor(gameState.finalGrade)}; margin-bottom: 0.5rem;">
                        ${gameState.finalGrade.toFixed(1)} / 5.0
                    </div>
                    <div style="font-size: 1.2rem; color: hsl(var(--muted-foreground));">
                        ${getGradeLabel(gameState.finalGrade)}
                    </div>
                </div>

                <!-- Estad√≠sticas detalladas -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="completion-stat">
                        <span>üìä Puntuaci√≥n Final:</span>
                        <span style="color: hsl(var(--accent)); font-weight: bold;">${gameState.score} ‚≠ê</span>
                    </div>
                    <div class="completion-stat">
                        <span>‚ù§Ô∏è Vidas Restantes:</span>
                        <span style="color: ${gameState.lives > 3 ? 'hsl(var(--accent))' : 'hsl(var(--destructive))'}; font-weight: bold;">
                            ${gameState.lives} / ${GAME_CONFIG.MAX_LIVES}
                        </span>
                    </div>
                    <div class="completion-stat">
                        <span>‚ùì Preguntas Respondidas:</span>
                        <span style="color: hsl(var(--primary)); font-weight: bold;">
                            ${gameState.questionsAnswered} / ${gameState.totalQuestionsInLevel}
                        </span>
                    </div>
                    <div class="completion-stat">
                        <span>üéØ Precisi√≥n:</span>
                        <span style="color: ${accuracy >= 80 ? 'hsl(var(--accent))' : accuracy >= 60 ? 'orange' : 'hsl(var(--destructive))'}; font-weight: bold;">
                            ${accuracy}% (${gameState.correctAnswers}/${gameState.questionsAnswered})
                        </span>
                    </div>
                    <div class="completion-stat">
                        <span>üçé Frutas Recolectadas:</span>
                        <span style="color: hsl(var(--primary)); font-weight: bold;">
                            ${completionPercentage}% (${gameState.fruitCollected}/${gameState.totalFruits})
                        </span>
                    </div>
                    <div class="completion-stat">
                        <span>üëª Fantasmas Enfrentados:</span>
                        <span style="color: hsl(var(--muted-foreground)); font-weight: bold;">
                            ${levelInfo.ghostCount}
                        </span>
                    </div>
                </div>

                <!-- An√°lisis de rendimiento -->
                <div style="background: hsl(var(--secondary) / 0.3); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: hsl(var(--accent)); margin-bottom: 0.75rem;">üìà An√°lisis de Rendimiento:</h4>
                    ${generatePerformanceAnalysis()}
                </div>

                <!-- Mensaje motivacional -->
                <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, hsl(var(--primary) / 0.1), hsl(var(--accent) / 0.1)); border-radius: 0.75rem; border-left: 4px solid hsl(var(--accent));">
                    <p style="font-size: 1.1rem; font-weight: 500; line-height: 1.5; color: hsl(var(--foreground));">
                        ${finalMessage}
                    </p>
                </div>
            </div>
            <div class="dialog-footer" style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button id="playAgainBtn" class="button button-primary" style="min-width: 150px;">
                    üîÑ Jugar de Nuevo
                </button>
                <button id="changeLevelBtn" class="button button-secondary" style="min-width: 150px;">
                    üìö Cambiar Nivel
                </button>
            </div>
        </div>
    `;
    
    completionDialog.innerHTML = completionHTML;
    completionDialog.style.display = 'flex';
    
    // Agregar event listeners
    const playAgainBtn = document.getElementById("playAgainBtn");
    const changeLevelBtn = document.getElementById("changeLevelBtn");
    
    if (playAgainBtn) {
        playAgainBtn.addEventListener("click", restartCurrentLevel);
    }
    
    if (changeLevelBtn) {
        changeLevelBtn.addEventListener("click", () => {
            completionDialog.style.display = 'none';
            resetGame();
        });
    }
}

/**
 * Obtiene el color seg√∫n la calificaci√≥n
 * @param {number} grade - Calificaci√≥n de 0 a 5
 * @returns {string} Color CSS
 */
function getGradeColor(grade) {
    if (grade >= 4.5) return "hsl(var(--accent))"; // Oro
    if (grade >= 4.0) return "#2ecc71"; // Verde
    if (grade >= 3.0) return "#3498db"; // Azul
    if (grade >= 2.0) return "orange"; // Naranja
    return "hsl(var(--destructive))"; // Rojo
}

/**
 * Obtiene la etiqueta seg√∫n la calificaci√≥n
 * @param {number} grade - Calificaci√≥n de 0 a 5
 * @returns {string} Etiqueta de rendimiento
 */
function getGradeLabel(grade) {
    if (grade >= 4.7) return "üèÜ SOBRESALIENTE";
    if (grade >= 4.0) return "üåü EXCELENTE";
    if (grade >= 3.5) return "üëç MUY BUENO";
    if (grade >= 3.0) return "‚úÖ BUENO";
    if (grade >= 2.0) return "üìö ACEPTABLE";
    return "üí™ NECESITA MEJORAR";
}

/**
 * Genera an√°lisis detallado del rendimiento
 * @returns {string} HTML del an√°lisis
 */
function generatePerformanceAnalysis() {
    const accuracy = gameState.questionsAnswered > 0 ? 
        (gameState.correctAnswers / gameState.questionsAnswered) * 100 : 0;
    const livesKept = (gameState.lives / GAME_CONFIG.MAX_LIVES) * 100;
    const completion = (gameState.fruitCollected / gameState.totalFruits) * 100;
    
    let analysis = [];
    
    // An√°lisis de precisi√≥n
    if (accuracy >= 90) {
        analysis.push("üéØ <strong>Excelente precisi√≥n</strong> - Dominas muy bien los conceptos");
    } else if (accuracy >= 70) {
        analysis.push("üëç <strong>Buena precisi√≥n</strong> - Entiendes bien la mayor√≠a de conceptos");
    } else if (accuracy >= 50) {
        analysis.push("üìö <strong>Precisi√≥n moderada</strong> - Revisa algunos conceptos b√°sicos");
    } else {
        analysis.push("üí° <strong>Necesitas m√°s pr√°ctica</strong> - Repasa los fundamentos te√≥ricos");
    }
    
    // An√°lisis de supervivencia
    if (livesKept >= 75) {
        analysis.push("üõ°Ô∏è <strong>Excelente estrategia</strong> - Navegaste el laberinto con habilidad");
    } else if (livesKept >= 50) {
        analysis.push("‚öñÔ∏è <strong>Estrategia balanceada</strong> - Buena gesti√≥n de riesgos");
    } else {
        analysis.push("‚ö° <strong>Juego arriesgado</strong> - Observa mejor los patrones de los fantasmas");
    }
    
    // An√°lisis de completitud
    if (completion === 100) {
        analysis.push("üèÅ <strong>Completitud total</strong> - ¬°Recolectaste todo!");
    } else if (completion >= 80) {
        analysis.push("üéØ <strong>Casi completo</strong> - Muy buen progreso");
    }
    
    return analysis.map(item => `<div style="margin-bottom: 0.5rem;">${item}</div>`).join('');
}

// ===============================================================
// üîÑ SISTEMA DE REINICIO Y CONTROLES GLOBALES
// ===============================================================

/**
 * Reinicia el nivel actual
 */
function restartCurrentLevel() {
    console.log("üîÑ Reiniciando nivel actual");
    completionDialog.style.display = 'none';
    startGame(); // Reutilizar la funci√≥n de inicio
}

/**
 * Resetea completamente el juego al estado inicial
 */
function resetGame() {
    console.log("üîÑ Reseteando juego completo");
    
    // Limpiar intervalos y timers
    if (gameState.ghostMovementInterval) {
        clearInterval(gameState.ghostMovementInterval);
        gameState.ghostMovementInterval = null;
    }
    
    if (gameState.vulnerableGhostsTimer) {
        clearTimeout(gameState.vulnerableGhostsTimer);
        gameState.vulnerableGhostsTimer = null;
    }
    
    // Limpiar event listeners
    document.removeEventListener("keydown", handleKeyDown);
    
    // Limpiar referencias DOM
    if (gameState.ghosts && gameState.ghosts.length > 0) {
        gameState.ghosts.forEach(ghost => {
            ghost.el = null;
        });
    }
    gameState.pacmanEl = null;
    
    // Resetear estado del juego
    gameState.gameStarted = false;
    gameState.gameCompleted = false;
    gameState.paused = false;
    gameState.score = 0;
    gameState.lives = GAME_CONFIG.MAX_LIVES;
    gameState.fruitCollected = 0;
    gameState.totalFruits = 0;
    gameState.questionsAnswered = 0;
    gameState.correctAnswers = 0;
    gameState.totalQuestionsInLevel = 0;
    gameState.ghosts = [];
    gameState.currentQuestion = null;
    gameState.questionPool = {};
    gameState.usedQuestions = [];
    gameState.ghostsVulnerable = false;
    gameState.powerPelletActive = false;
    gameState.questionStartTime = null;
    
    // Ocultar todos los di√°logos
    completionDialog.style.display = 'none';
    questionDialog.style.display = 'none';
    helpDialog.style.display = 'none';
    
    // Resetear botones globales
    globalPauseBtn.textContent = "‚è∏Ô∏è Pausar";
    globalPauseBtn.disabled = false;
    
    // Volver al selector de niveles
    renderApp();
    
    console.log("‚úÖ Juego reseteado completamente");
}

/**
 * Alterna el estado de pausa del juego
 */
function togglePause() {
    // No permitir pausa en ciertos estados
    if (gameState.gameCompleted ||
        !gameState.gameStarted ||
        (questionDialog && questionDialog.style.display !== 'none') ||
        (helpDialog && helpDialog.style.display !== 'none') ||
        (completionDialog && completionDialog.style.display !== 'none')) {
        return;
    }

    if (!gameState.paused) {
        // Pausar juego
        gameState.paused = true;
        
        if (gameState.ghostMovementInterval) {
            clearInterval(gameState.ghostMovementInterval);
            gameState.ghostMovementInterval = null;
        }
        
        globalPauseBtn.textContent = "‚ñ∂Ô∏è Reanudar";
        showToast("‚è∏Ô∏è Pausado", "El juego est√° en pausa", "default");
        
        console.log("‚è∏Ô∏è Juego pausado");
    } else {
        // Reanudar juego
        gameState.paused = false;
        
        if (!gameState.gameCompleted) {
            const ghostSpeed = GAME_CONFIG.LEVELS[gameState.level].ghostSpeed;
            gameState.ghostMovementInterval = setInterval(moveGhosts, ghostSpeed);
        }
        
        globalPauseBtn.textContent = "‚è∏Ô∏è Pausar";
        showToast("‚ñ∂Ô∏è Reanudado", "El juego contin√∫a", "success");
        
        console.log("‚ñ∂Ô∏è Juego reanudado");
    }
}

// ===============================================================
// üñ•Ô∏è MANEJO DE REDIMENSIONAMIENTO Y RESPONSIVIDAD
// ===============================================================

/**
 * Maneja el redimensionamiento de la ventana
 */
function handleWindowResize() {
    if (gameState.gameStarted && !gameState.gameCompleted) {
        console.log("üì± Redimensionando juego");
        
        // Re-renderizar solo si es necesario
        const currentWidth = document.getElementById("mazeContainer")?.style.width;
        if (currentWidth) {
            renderGame(); // Re-calcular tama√±os y re-renderizar
        }
    }
}

// ===============================================================
// üöÄ INICIALIZACI√ìN COMPLETA DE LA APLICACI√ìN
// ===============================================================

/**
 * Inicializa toda la aplicaci√≥n
 */
function initializeApp() {
    console.log("üöÄ Inicializando aplicaci√≥n completa");
    
    // Configurar event listeners globales
    if (globalPauseBtn) {
        globalPauseBtn.addEventListener("click", togglePause);
    }
    
    if (globalResetBtn) {
        globalResetBtn.addEventListener("click", resetGame);
    }
    
    // Configurar manejo de redimensionamiento
    let resizeTimeout;
    window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(handleWindowResize, 250); // Debounce
    });
    
    // Prevenir zoom en dispositivos m√≥viles durante el juego
    if (isMobile) {
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });
        
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    }
    
    // Manejar visibilidad de la p√°gina (pausar cuando se oculta)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && gameState.gameStarted && !gameState.paused && !gameState.gameCompleted) {
            togglePause();
        }
    });
    
    // Renderizar la aplicaci√≥n inicial
    renderApp();
    
    console.log("‚úÖ Aplicaci√≥n inicializada correctamente");
}

// ===============================================================
// üì± DETECCI√ìN DE CARACTER√çSTICAS DEL DISPOSITIVO
// ===============================================================

/**
 * Detecta las caracter√≠sticas del dispositivo y ajusta la configuraci√≥n
 */
function detectDeviceCapabilities() {
    // Detectar soporte para vibraciones
    const hasVibration = 'vibrate' in navigator;
    
    // Detectar orientaci√≥n
    const isLandscape = window.innerWidth > window.innerHeight;
    
    // Detectar rendimiento (aproximado)
    const hasHighPerformance = window.devicePixelRatio <= 2 && 
                               window.innerWidth <= 1920 &&
                               !isMobile;
    
    // Ajustar configuraci√≥n seg√∫n capacidades
    if (!hasHighPerformance) {
        // Reducir velocidad de animaciones en dispositivos menos potentes
        document.documentElement.style.setProperty('--animation-speed', '0.2s');
    }
    
    // Mostrar sugerencia de orientaci√≥n en m√≥viles
    if (isMobile && !isLandscape && gameState.gameStarted) {
        showToast(
            "üì± Sugerencia", 
            "Para mejor experiencia, usa orientaci√≥n horizontal", 
            "default"
        );
    }
    
    console.log(`üì± Dispositivo: Mobile=${isMobile}, Landscape=${isLandscape}, HighPerf=${hasHighPerformance}`);
}

// ===============================================================
// üéØ FUNCIONES DE UTILIDAD ADICIONALES
// ===============================================================

/**
 * Obtiene estad√≠sticas detalladas del juego para an√°lisis
 * @returns {Object} Objeto con estad√≠sticas completas
 */
function getGameStatistics() {
    return {
        level: gameState.level,
        score: gameState.score,
        lives: gameState.lives,
        questionsAnswered: gameState.questionsAnswered,
        correctAnswers: gameState.correctAnswers,
        accuracy: gameState.questionsAnswered > 0 ? 
            (gameState.correctAnswers / gameState.questionsAnswered) * 100 : 0,
        completion: (gameState.fruitCollected / gameState.totalFruits) * 100,
        finalGrade: gameState.finalGrade,
        gameCompleted: gameState.gameCompleted,
        timestamp: new Date().toISOString()
    };
}

/**
 * Funci√≥n de debug para desarrolladores
 */
function debugGameState() {
    console.group("üîç Estado del Juego - Debug");
    console.log("Estado general:", {
        level: gameState.level,
        started: gameState.gameStarted,
        completed: gameState.gameCompleted,
        paused: gameState.paused
    });
    console.log("Progreso:", {
        score: gameState.score,
        lives: gameState.lives,
        fruitCollected: gameState.fruitCollected,
        totalFruits: gameState.totalFruits,
        questionsAnswered: gameState.questionsAnswered,
        correctAnswers: gameState.correctAnswers
    });
    console.log("Posiciones:", {
        player: gameState.playerPosition,
        ghosts: gameState.ghosts.map(g => ({id: g.id, pos: g.position, vulnerable: g.vulnerable}))
    });
    console.groupEnd();
}

// Hacer disponible la funci√≥n de debug globalmente (solo en desarrollo)
if (typeof window !== 'undefined') {
    window.debugPhysicsGame = debugGameState;
    window.gameStats = getGameStatistics;
}

// ===============================================================
// üèÅ INICIALIZACI√ìN FINAL Y ARRANQUE
// ===============================================================

// Esperar a que el DOM est√© completamente cargado
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        detectDeviceCapabilities();
        initializeApp();
    });
} else {
    // DOM ya est√° listo
    detectDeviceCapabilities();
    initializeApp();
}

// ===============================================================
// üìù LOGGING FINAL
// ===============================================================

console.log("üî¨ Laberinto de F√≠sica v3 - Parte 5 Final cargada exitosamente");
console.log("üéâ JUEGO COMPLETAMENTE FUNCIONAL");
console.log("‚úÖ Caracter√≠sticas implementadas:");
console.log("   - Sistema completo de preguntas (105+ preguntas organizadas por temas)");
console.log("   - 4 niveles de dificultad con configuraci√≥n espec√≠fica");
console.log("   - IA de fantasmas inteligente y adaptativa");
console.log("   - Sistema de calificaci√≥n educativo (0-5.0)");
console.log("   - Controles t√°ctiles y de teclado");
console.log("   - Dise√±o responsivo y adaptativo");
console.log("   - Power pellets con vulnerabilidad temporal");
console.log("   - Notificaciones y feedback inmediato");
console.log("   - An√°lisis detallado de rendimiento");
console.log("   - Controles globales de pausa/reinicio");
console.log("");
console.log("üéÆ Para debug, usa: window.debugPhysicsGame()");
console.log("üìä Para estad√≠sticas, usa: window.gameStats()");
console.log("");
console.log("üöÄ ¬°JUEGO LISTO PARA JUGAR!");

// ===============================================================
// üéä MENSAJE DE BIENVENIDA
// ===============================================================

// Mostrar mensaje de bienvenida despu√©s de un breve delay
setTimeout(() => {
    if (!gameState.gameStarted) {
        showToast(
            "üî¨ ¬°Bienvenido al Laberinto de F√≠sica!", 
            "Aprende f√≠sica jugando. Selecciona tu nivel y comienza la aventura.", 
            "success"
        );
    }
}, 1000);

    </script>
</body>
</html>